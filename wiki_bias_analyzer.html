<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wikipedia Bias Analyzer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
<script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script>
window.onerror = function(msg, src, line, col, err) {
  var root = document.getElementById("root");
  if (root && !root.innerHTML.trim()) {
    root.innerHTML = '<div style="max-width:600px;margin:60px auto;padding:24px;background:#fff;border:1px solid #e8d5c4;font-family:sans-serif">'
      + '<h2 style="color:#990f3d;margin-bottom:12px">Failed to load analyzer</h2>'
      + '<p style="margin-bottom:8px">Error: ' + msg + '</p>'
      + '<p style="font-size:13px;color:#666">Line ' + line + ', Col ' + col + '</p>'
      + '<p style="margin-top:12px;font-size:13px">Try: <strong>Ctrl+Shift+R</strong> (hard refresh) or clear browser cache.</p>'
      + '</div>';
  }
  console.error("Global error:", msg, "at", src, line, col, err);
};
</script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Source Sans 3', Georgia, 'Times New Roman', serif; background: #fff1e5; min-height: 100vh; color: #33302e; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { width: 48px; height: 48px; border: 3px solid #e8d5c4; border-top-color: #990f3d; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }

  /* Layout */
  .center-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }
  .container { max-width: 768px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; min-height: 100vh; }
  .card { background: #fff; border: none; border-radius: 0; box-shadow: none; overflow: hidden; border-top: 4px solid #990f3d; }

  /* Search */
  .search-box { width: 100%; max-width: 560px; }
  .search-input { width: 100%; padding: 14px 18px; font-size: 17px; font-family: 'Source Sans 3', sans-serif; border: 1px solid #ccc1b7; border-radius: 0; outline: none; background: #fff; transition: border-color 0.2s; }
  .search-input:focus { border-color: #990f3d; }
  .search-input::placeholder { color: #a39d97; }
  .suggestions { position: absolute; top: 100%; left: 0; right: 0; margin-top: 2px; background: #fff; border: 1px solid #ccc1b7; border-radius: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.08); z-index: 50; overflow: hidden; }
  .suggestion-btn { width: 100%; text-align: left; padding: 10px 18px; border: none; background: none; cursor: pointer; color: #33302e; font-size: 15px; font-family: 'Source Sans 3', sans-serif; border-bottom: 1px solid #f2dfce; transition: background 0.15s; }
  .suggestion-btn:hover { background: #fff1e5; }
  .suggestion-btn:last-child { border-bottom: none; }

  /* Buttons */
  .btn-primary { padding: 12px 32px; background: #0d7680; color: #fff; font-weight: 600; font-size: 15px; font-family: 'Source Sans 3', sans-serif; border: none; border-radius: 0; cursor: pointer; transition: background 0.2s; }
  .btn-primary:hover { background: #0a5e66; }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-secondary { padding: 8px 16px; background: #f2dfce; color: #66605c; font-size: 14px; font-family: 'Source Sans 3', sans-serif; border: none; border-radius: 0; cursor: pointer; transition: background 0.15s; }
  .btn-secondary:hover { background: #e8d5c4; }

  /* Section (collapsible) */
  .section-header { width: 100%; display: flex; align-items: center; gap: 12px; padding: 14px 20px; background: #fff; border: none; border-bottom: 1px solid #e8d5c4; cursor: pointer; text-align: left; transition: background 0.15s; }
  .section-header:hover { background: #fff9f5; }
  .section-icon { font-size: 16px; }
  .section-title { font-family: 'Playfair Display', Georgia, serif; font-weight: 700; color: #33302e; flex: 1; font-size: 16px; letter-spacing: -0.01em; }
  .section-toggle { color: #a39d97; font-size: 16px; }
  .section-body { padding: 16px 20px; display: flex; flex-direction: column; gap: 16px; }

  /* Stats grid */
  .stats-grid { display: grid; gap: 16px; }
  .stats-4 { grid-template-columns: repeat(4, 1fr); }
  .stats-5 { grid-template-columns: repeat(5, 1fr); }
  .stat { text-align: center; }
  .stat-value { font-size: 22px; font-weight: 700; color: #33302e; font-family: 'Playfair Display', Georgia, serif; }
  .stat-label { font-size: 11px; color: #66605c; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
  .stat-sub { font-size: 11px; color: #a39d97; }

  /* Bars */
  .metric-row { display: flex; align-items: center; gap: 12px; }
  .metric-label { font-size: 13px; color: #66605c; width: 140px; flex-shrink: 0; }
  .metric-track { flex: 1; height: 18px; background: #f2dfce; border-radius: 0; overflow: hidden; }
  .metric-fill { height: 100%; border-radius: 0; transition: width 0.5s; }
  .metric-value { font-size: 13px; font-family: 'Source Sans 3', monospace; color: #33302e; width: 72px; text-align: right; }

  /* Sentiment bars */
  .sent-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
  .sent-name { font-size: 12px; color: #66605c; width: 176px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .sent-track { flex: 1; height: 12px; background: #f2dfce; border-radius: 0; overflow: hidden; position: relative; }
  .sent-center { position: absolute; top: 0; bottom: 0; width: 1px; background: #ccc1b7; left: 50%; }
  .sent-fill { position: absolute; top: 0; bottom: 0; border-radius: 0; opacity: 0.8; }
  .sent-val { font-size: 12px; font-family: monospace; width: 56px; text-align: right; color: #33302e; }

  /* Bias spectrum */
  .spectrum-bar { position: relative; height: 32px; border-radius: 0; overflow: hidden; background: linear-gradient(to right, #082a75, #2e6c9e, #a39d97, #c0392b, #990f3d); }
  .spectrum-marker { position: absolute; top: 0; bottom: 0; width: 4px; background: #fff; border: 2px solid #33302e; border-radius: 0; z-index: 10; transform: translateX(-50%); }
  .spectrum-labels { position: absolute; inset: 0; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; font-size: 11px; font-weight: 700; color: #fff; }
  .dist-bar-row { display: flex; gap: 4px; height: 64px; align-items: flex-end; }
  .dist-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .dist-fill { border-radius: 0; width: 100%; }
  .dist-count { font-size: 11px; color: #66605c; }
  .dist-labels { display: flex; justify-content: space-between; font-size: 11px; color: #a39d97; }

  /* Source list */
  .source-row { display: flex; align-items: center; gap: 8px; font-size: 13px; padding: 3px 0; border-bottom: 1px solid #f2dfce; }
  .source-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .source-domain { color: #33302e; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .source-rating { color: #66605c; font-size: 12px; }
  .source-count { font-family: monospace; color: #66605c; width: 32px; text-align: right; }

  /* Misc */
  .desc { font-size: 13px; color: #66605c; line-height: 1.5; }
  .desc a { color: #0d7680; text-decoration: none; border-bottom: 1px solid #0d7680; }
  .desc a:hover { color: #990f3d; border-color: #990f3d; }
  .section-prop-row { display: flex; align-items: center; gap: 8px; }
  .section-prop-name { font-size: 12px; color: #66605c; width: 176px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .section-prop-track { flex: 1; height: 14px; background: #f2dfce; border-radius: 0; overflow: hidden; }
  .section-prop-fill { height: 100%; background: #0d7680; border-radius: 0; }
  .section-prop-val { font-size: 12px; font-family: monospace; color: #66605c; width: 56px; text-align: right; }
  .tag { display: inline-block; padding: 4px 10px; border-radius: 0; font-size: 12px; border: 1px solid; }
  .tag-green { background: #e6f3ed; color: #0a5e3a; border-color: #0a5e3a; }
  .tag-gray { background: #f2dfce; color: #a39d97; border-color: #ccc1b7; }
  .quote-box { font-size: 13px; color: #66605c; padding: 12px 16px; margin-top: 4px; border-left: 3px solid; }
  .quote-green { background: #f5fbf8; border-color: #0d7680; }
  .quote-red { background: #fdf5f5; border-color: #990f3d; }
  .quote-label-green { font-weight: 600; color: #0d7680; }
  .quote-label-red { font-weight: 600; color: #990f3d; }
  .example-line { font-size: 13px; color: #66605c; }
  .example-bold { font-weight: 600; color: #33302e; }
  .footer { text-align: center; font-size: 12px; color: #a39d97; padding: 24px 0; border-top: 1px solid #e8d5c4; }
  .five-col { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; text-align: center; font-size: 12px; color: #a39d97; padding-top: 16px; }
  .header-bar { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 16px 20px; border-top: 4px solid #990f3d; }
  .header-title { font-size: 20px; font-weight: 700; color: #33302e; font-family: 'Playfair Display', Georgia, serif; }
  .header-sub { font-size: 13px; color: #66605c; }
  .small-title { font-size: 13px; font-weight: 600; color: #33302e; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.03em; }
  .tags-row { display: flex; gap: 12px; margin-top: 12px; }

  @media (max-width: 640px) {
    .stats-4 { grid-template-columns: repeat(2, 1fr); }
    .stats-5 { grid-template-columns: repeat(3, 1fr); }
    .metric-label { width: 100px; }
    .sent-name { width: 100px; }
    .section-prop-name { width: 100px; }
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useRef, Component } = React;

class ErrorBoundary extends Component {
  constructor(props) { super(props); this.state = { hasError: false, error: null }; }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, info) { console.error("React Error Boundary caught:", error, info); }
  render() {
    if (this.state.hasError) {
      return (
        <div style={{maxWidth:"600px",margin:"60px auto",padding:"24px",background:"#fff",border:"1px solid #e8d5c4",fontFamily:"sans-serif"}}>
          <h2 style={{color:"#990f3d",marginBottom:"12px"}}>Something went wrong</h2>
          <p style={{marginBottom:"8px"}}>{this.state.error?.message || "Unknown error"}</p>
          <pre style={{fontSize:"12px",color:"#666",background:"#f6f1eb",padding:"12px",overflow:"auto",maxHeight:"200px"}}>{this.state.error?.stack}</pre>
          <button onClick={() => window.location.reload()} style={{marginTop:"12px",padding:"8px 16px",background:"#990f3d",color:"#fff",border:"none",cursor:"pointer"}}>Reload Page</button>
        </div>
      );
    }
    return this.props.children;
  }
}

// ═══════════════════════════════════════════════════════════════════
// MEDIA BIAS RATINGS — 219 outlets
// Sources: AllSides v11 (Dec 2025), MBFC, Institutional classification
// Scale: -2=Left, -1=Lean Left, 0=Center, +1=Lean Right, +2=Right
// ═══════════════════════════════════════════════════════════════════
const ALLSIDES = {
  // ── LEFT (-2) ──
  "alternet.org":-2,"apnews.com":-2,"commondreams.org":-2,"crooksandliars.com":-2,
  "currentaffairs.org":-2,"dailybeast.com":-2,"dailykos.com":-2,"democracynow.org":-2,
  "huffingtonpost.com":-2,"huffpost.com":-2,"jacobin.com":-2,"motherjones.com":-2,
  "msnbc.com":-2,"newrepublic.com":-2,"occupydemocrats.com":-2,"rawstory.com":-2,
  "salon.com":-2,"shareblue.com":-2,"slate.com":-2,"theatlantic.com":-2,"thedailybeast.com":-2,
  "theintercept.com":-2,"thenation.com":-2,"thinkprogress.org":-2,"truthout.org":-2,
  "vox.com":-2,
  // ── LEAN LEFT (-1) ──
  "abc.net.au":-1,"abcnews.go.com":-1,"aljazeera.com":-1,"axios.com":-1,"bbc.co.uk":-1,
  "bbc.com":-1,"bloomberg.com":-1,"businessinsider.com":-1,"buzzfeednews.com":-1,
  "caravanmagazine.in":-1,"cbc.ca":-1,"cbsnews.com":-1,"cnbc.com":-1,"cnn.com":-1,"dw.com":-1,
  "economist.com":-1,"firstpost.com":-1,"foreignaffairs.com":-1,"ft.com":-1,"gizmodo.com":-1,
  "globalnews.ca":-1,"haaretz.com":-1,"independent.co.uk":-1,"insider.com":-1,
  "irishtimes.com":-1,"latimes.com":-1,"macleans.ca":-1,"mashable.com":-1,
  "mediamatters.org":-1,"nbcnews.com":-1,"ndtv.com":-1,"newslaundry.com":-1,"newyorker.com":-1,
  "npr.org":-1,"nytimes.com":-1,"nzherald.co.nz":-1,"pbs.org":-1,"politico.com":-1,
  "propublica.org":-1,"rollingstone.com":-1,"scientificamerican.com":-1,"scroll.in":-1,
  "smh.com.au":-1,"talkingpointsmemo.com":-1,"teenvogue.com":-1,"theage.com.au":-1,
  "theconversation.com":-1,"theglobeandmail.com":-1,"theguardian.com":-1,"thehill.com":-1,
  "thehindu.com":-1,"thenewsminute.com":-1,"thestar.com":-1,"theverge.com":-1,"thewire.in":-1,
  "time.com":-1,"usatoday.com":-1,"vanityfair.com":-1,"vice.com":-1,"vogue.com":-1,
  "washingtonpost.com":-1,"wired.com":-1,
  // ── CENTER (0) ──
  "1440.com":0,"acm.org":0,"allsides.com":0,"apa.org":0,"arxiv.org":0,"biorxiv.org":0,
  "bls.gov":0,"bmj.com":0,"britannica.com":0,"brookings.edu":0,"c-span.org":0,
  "cambridge.org":0,"cdc.gov":0,"cell.com":0,"census.gov":0,"cfr.org":0,
  "channelnewsasia.com":0,"cochrane.org":0,"cochranelibrary.com":0,"congress.gov":0,
  "csmonitor.com":0,"deccanherald.com":0,"doi.org":0,"epa.gov":0,"europa.eu":0,
  "europarl.europa.eu":0,"factcheck.org":0,"fda.gov":0,"france24.com":0,"frontiersin.org":0,
  "gallup.com":0,"hindustantimes.com":0,"ieee.org":0,"imf.org":0,"indianexpress.com":0,
  "indiatoday.in":0,"japantimes.co.jp":0,"jstor.org":0,"koreaherald.com":0,"livemint.com":0,
  "loc.gov":0,"marketwatch.com":0,"medrxiv.org":0,"morningbrew.com":0,"nasa.gov":0,
  "nature.com":0,"ncbi.nlm.nih.gov":0,"nejm.org":0,"newsnation.com":0,"newsweek.com":0,
  "nih.gov":0,"noaa.gov":0,"oxford.com":0,"oxfordjournals.org":0,"pewresearch.org":0,
  "plos.org":0,"pnas.org":0,"politifact.com":0,"pubmed.ncbi.nlm.nih.gov":0,"rand.org":0,
  "realclearpolitics.com":0,"researchgate.net":0,"reuters.com":0,"scholar.google.com":0,
  "science.org":0,"sciencedirect.com":0,"scmp.com":0,"skynews.com":0,"snopes.com":0,
  "springer.com":0,"ssrn.com":0,"straightarrownews.com":0,"straitstimes.com":0,
  "supremecourt.gov":0,"tandfonline.com":0,"tangle.media":0,"theaustralian.com.au":0,
  "thelancet.com":0,"theprint.in":0,"timesofindia.indiatimes.com":0,"un.org":0,"who.int":0,
  "wiley.com":0,"worldbank.org":0,"wsj.com":0,
  // ── ARCHIVAL / REFERENCE (rated 0 = neutral) ──
  "archive.org":0,"web.archive.org":0,"books.google.com":0,"scholar.google.com":0,
  "worldcat.org":0,"biodiversitylibrary.org":0,"europeana.eu":0,"gutenberg.org":0,
  "smithsonianmag.com":0,"si.edu":0,"nobelprize.org":0,"iop.org":0,"rsc.org":0,
  "acs.org":0,"aip.org":0,"aps.org":0,"royalsociety.org":0,"nationalgeographic.com":0,
  "iucn.org":0,"wmo.int":0,"icrc.org":0,"amnesty.org":0,"hrw.org":0,
  // ── LEAN RIGHT (+1) ──
  "dailymail.co.uk":1,"dailywire.com":1,"dnaindia.com":1,"epochtimes.com":1,"forbes.com":1,
  "foxbusiness.com":1,"freebeacon.com":1,"ijr.com":1,"judicialwatch.org":1,
  "nationalreview.com":1,"nypost.com":1,"postmillennial.com":1,"realclearinvestigations.com":1,
  "reason.com":1,"republicworld.com":1,"skynews.com.au":1,"spectator.co.uk":1,
  "spectator.com.au":1,"swarajyamag.com":1,"telegraph.co.uk":1,"theamericanconservative.com":1,
  "thedispatch.com":1,"thefreepress.com":1,"timesnownews.com":1,"washingtonexaminer.com":1,
  "washingtontimes.com":1,"zerohedge.com":1,
  // ── RIGHT (+2) ──
  "breitbart.com":2,"dailycaller.com":2,"foxnews.com":2,"hannity.com":2,"infowars.com":2,
  "newsmax.com":2,"oann.com":2,"opindia.com":2,"pjmedia.com":2,"redstate.com":2,"rt.com":2,
  "sputniknews.com":2,"theblaze.com":2,"thefederalist.com":2,"thegatewaypundit.com":2,
  "townhall.com":2,"twitchy.com":2,"westernjournal.com":2,"wnd.com":2,
};
const BIAS_LABELS = {"-2":"Left","-1":"Lean Left","0":"Center","1":"Lean Right","2":"Right"};
const BIAS_COLORS = {"-2":"#082a75","-1":"#2e6c9e","0":"#66605c","1":"#c0392b","2":"#990f3d"};

// ═══════════════════════════════════════════════════════════════════
// WIKIPEDIA POLICY WORD LISTS
// ═══════════════════════════════════════════════════════════════════
const WEASEL = [
  "some say","some people","some argue","many people","many believe","many scholars",
  "many feel","most people","most believe","most feel","experts say","experts believe",
  "experts claim","critics say","critics argue","critics claim","observers note",
  "analysts say","research has shown","studies have shown","studies suggest",
  "everyone knows","it is said","it is thought","it is believed",
  "it is widely thought","it is widely believed","it is generally thought",
  "it is commonly believed","it is often said","it is often reported",
  "it is widely regarded","it is considered","it is claimed",
  "it has been suggested","it has been said","it has been claimed",
  "it has been argued","widely regarded as","generally considered",
  "science says","scientists claim","supporters argue","opponents argue",
  "some evidence","evidence suggests","growing number","a number of","significant number",
];
const PEACOCK = [
  "legendary","iconic","renowned","world-renowned","world-famous","prestigious",
  "illustrious","groundbreaking","revolutionary","pioneering","trailblazing",
  "visionary","brilliant","extraordinary","remarkable","exceptional","outstanding",
  "stunning","spectacular","masterpiece","tour de force","acclaimed",
  "critically acclaimed","award-winning","best-selling","best known",
  "widely considered","unmatched","unrivaled","unparalleled","foremost",
  "preeminent","one of the greatest","one of the most","one of the best",
  "widely praised","hugely successful","immensely popular","show-stopping",
  "chart-topping","blockbuster","runaway success","cutting-edge",
  "state-of-the-art","innovative",
];
const EDITORIAL = [
  "revealed","exposed","unveiled","admitted","confessed","conceded","denied",
  "insisted","boasted","clarified","pointed out","noted","of course",
  "needless to say","clearly","obviously","undeniably","unquestionably",
  "indisputably","without a doubt","without question","naturally","inevitably",
  "interestingly","surprisingly","remarkably","ironically","significantly",
  "importantly","crucially","notably","controversially","famously","infamously",
  "so-called","allegedly","purportedly","supposedly",
];
const HEDGING = [
  "may","might","could","would","possibly","perhaps","arguably","probably",
  "apparently","seemingly","seem","seems","seemed","appear","appears","appeared",
  "suggest","suggests","suggested","tend","tends","tended","generally","typically",
  "usually","often","sometimes","rarely","to some extent","in some cases",
];
const INTENSIFIERS = [
  "very","extremely","highly","incredibly","enormously","tremendously","deeply",
  "profoundly","overwhelmingly","drastically","sharply","dramatically","vastly",
  "massively","immensely","significantly",
];
const SUPERLATIVES = [
  "best","worst","greatest","largest","smallest","most","least","first ever",
  "biggest","strongest","weakest","highest","lowest","finest","poorest",
];

// ═══════════════════════════════════════════════════════════════════
// COMPACT VADER SENTIMENT LEXICON (~1,200 high-impact words)
// ═══════════════════════════════════════════════════════════════════
const VADER_LEX = {
  "abandon":-1.6,"abandoned":-1.8,"abandons":-1.6,"abhor":-2.6,"abhorred":-2.7,
  "abhorrent":-2.8,"abuse":-3.0,"abused":-2.9,"abuses":-2.6,"abusive":-3.0,
  "acclaim":2.5,"acclaimed":2.6,"accomplish":2.0,"accomplished":2.2,
  "achievement":2.4,"achievements":2.2,"adequate":0.8,"admirable":2.2,
  "admire":2.5,"admired":2.4,"adorable":2.5,"adore":2.7,"adored":2.5,
  "advantage":1.6,"advantages":1.6,"adverse":-1.8,"adversely":-1.9,
  "afraid":-1.8,"aggravate":-1.8,"aggressive":-1.5,"agony":-2.8,
  "agree":1.2,"agreeable":1.6,"agreed":1.2,"alarm":-1.5,"alarming":-2.0,
  "alert":-0.3,"alienate":-1.5,"alive":1.2,"allegation":-1.2,"allege":-1.1,
  "amazing":2.6,"ambitious":1.2,"amuse":1.8,"amused":1.8,"amusing":1.9,
  "anger":-2.1,"angry":-2.3,"anguish":-2.5,"annihilate":-2.4,"annoy":-1.6,
  "annoyed":-1.8,"annoying":-1.9,"antagonize":-1.7,"anxiety":-1.6,
  "anxious":-1.1,"apathetic":-1.2,"apologize":0.6,"appall":-2.3,
  "appalling":-2.5,"applaud":2.1,"applause":2.2,"appreciate":1.9,
  "appreciated":2.0,"appreciation":2.1,"apprehensive":-1.2,"appropriate":1.0,
  "approval":1.7,"approve":1.7,"approved":1.6,"ardent":1.3,"arrest":-1.9,
  "arrogant":-2.0,"ashamed":-1.8,"assault":-2.8,"asset":1.2,"astonish":1.5,
  "atrocious":-3.2,"atrocity":-3.4,"attack":-2.1,"attacked":-2.2,
  "attacks":-2.0,"attractive":2.0,"austere":-0.8,"authority":0.5,
  "aversion":-1.6,"avoid":-0.8,"avoided":-0.8,"awful":-2.5,"awkward":-1.1,
  "bad":-2.5,"ban":-1.6,"banned":-1.7,"barbaric":-2.8,"bastard":-3.4,
  "battle":-1.4,"beautiful":2.7,"beauty":2.6,"befriend":1.5,"beg":-1.2,
  "beneficial":1.8,"benefit":1.6,"benefits":1.6,"benevolent":2.0,
  "best":2.2,"betray":-2.8,"betrayal":-2.9,"better":1.5,"bias":-1.4,
  "biased":-1.6,"bitter":-2.0,"bitterness":-2.1,"bizarre":-1.0,
  "blame":-2.0,"blamed":-2.1,"bless":1.8,"blessed":2.0,"blessing":2.2,
  "blind":-0.6,"bliss":2.8,"block":-1.0,"blocked":-1.1,"bloody":-2.0,
  "bold":1.3,"bomb":-2.5,"bonus":1.5,"bore":-1.5,"bored":-1.5,
  "boring":-2.0,"bother":-1.3,"brave":2.0,"bravery":2.4,"breach":-1.5,
  "break":-0.9,"brilliant":2.8,"broken":-1.8,"brutal":-2.8,"brutality":-3.0,
  "bully":-2.5,"burden":-1.6,"calm":1.3,"cancel":-1.0,"capable":1.5,
  "captivate":2.0,"care":1.5,"careful":1.0,"careless":-1.5,"catastrophe":-3.0,
  "catastrophic":-3.2,"celebrate":2.3,"celebrated":2.2,"celebration":2.4,
  "censorship":-1.6,"challenge":-0.5,"champion":2.0,"chaos":-2.2,
  "chaotic":-2.0,"charm":1.8,"charming":2.2,"cheap":-1.0,"cheat":-2.5,
  "cheated":-2.6,"cheerful":2.2,"cherish":2.4,"civil":0.8,"claim":-0.3,
  "clash":-1.6,"clean":1.0,"clever":1.8,"collapse":-2.2,"collusion":-2.0,
  "combat":-1.4,"comfort":1.8,"comfortable":1.6,"command":0.5,
  "commend":2.0,"commit":-0.2,"committed":0.6,"compassion":2.2,
  "compassionate":2.4,"compel":-0.3,"competent":1.5,"complain":-1.5,
  "complaint":-1.5,"compliment":2.0,"compromise":0.3,"concern":-0.8,
  "concerned":-0.9,"condemn":-2.3,"condemned":-2.4,"condemnation":-2.4,
  "confidence":1.8,"confident":1.8,"conflict":-1.8,"confuse":-1.2,
  "confused":-1.3,"confusion":-1.3,"congratulate":2.3,"conquer":1.2,
  "conscience":0.8,"consent":0.8,"conservative":0.0,"conspiracy":-1.8,
  "constructive":1.5,"contaminate":-2.0,"contempt":-2.3,"content":1.5,
  "contented":1.6,"controversial":-1.0,"controversy":-1.2,"convenient":1.2,
  "conviction":-0.4,"cooperate":1.5,"cooperation":1.6,"correct":1.2,
  "corrupt":-2.8,"corruption":-2.8,"costly":-1.2,"courage":2.2,
  "courageous":2.4,"courteous":1.6,"crash":-2.0,"crazy":-1.6,
  "creative":1.8,"crime":-2.5,"criminal":-2.2,"crisis":-2.2,"critic":-0.8,
  "critical":-1.0,"criticism":-1.2,"criticize":-1.5,"criticized":-1.6,
  "cruel":-2.8,"cruelty":-3.0,"crush":-1.8,"cry":-1.5,"cure":1.8,
  "curious":1.0,"damage":-2.2,"damaged":-2.2,"danger":-2.0,"dangerous":-2.2,
  "daring":1.3,"dark":-1.0,"deadly":-2.8,"death":-2.5,"debate":-0.3,
  "decay":-1.8,"deceit":-2.5,"deceive":-2.5,"decent":1.2,"decisive":1.2,
  "decline":-1.5,"defeat":-2.0,"defeated":-2.2,"defend":0.8,"defense":0.5,
  "defiant":-0.5,"defy":-0.6,"degrade":-2.2,"delay":-1.0,"deliberate":-0.3,
  "delight":2.5,"delighted":2.6,"delightful":2.7,"demand":-0.8,
  "democracy":1.0,"demolish":-2.0,"demonstrate":0.5,"denial":-1.4,
  "denounce":-2.0,"deny":-1.2,"depressed":-2.2,"depression":-2.0,
  "deprive":-1.8,"deride":-2.0,"deserve":0.8,"desire":1.2,"despair":-2.5,
  "desperate":-2.0,"despicable":-3.0,"despise":-2.8,"destroy":-2.8,
  "destroyed":-2.8,"destruction":-2.8,"destructive":-2.5,"detain":-1.5,
  "determined":1.3,"devastating":-2.8,"devastation":-3.0,"devote":1.5,
  "devoted":1.8,"dignity":1.6,"dire":-2.2,"dirty":-1.8,"disable":-1.2,
  "disabled":-0.8,"disadvantage":-1.5,"disagree":-1.0,"disappear":-0.8,
  "disappoint":-1.8,"disappointed":-1.8,"disappointing":-2.0,
  "disappointment":-2.0,"disaster":-2.8,"disastrous":-3.0,"disbelief":-1.2,
  "discord":-1.5,"discourage":-1.5,"discriminate":-2.0,"discrimination":-2.2,
  "disease":-1.8,"disgrace":-2.5,"disgusting":-3.0,"dishonest":-2.5,
  "dislike":-1.5,"dismiss":-1.2,"dismissed":-1.3,"disorder":-1.5,
  "dispute":-1.3,"disrespect":-2.0,"disrupt":-1.5,"disruption":-1.5,
  "dissent":-0.8,"distort":-1.8,"distress":-2.0,"disturb":-1.5,
  "disturbing":-2.2,"diverse":1.0,"divide":-1.0,"divine":2.0,
  "dominate":-0.8,"doom":-2.5,"doubt":-1.2,"dread":-2.2,"dreadful":-2.8,
  "dream":1.5,"dull":-1.2,"eager":1.5,"ease":1.2,"effective":1.5,
  "efficient":1.5,"effort":0.8,"elegant":2.0,"eliminate":-0.8,
  "embarrass":-1.8,"embarrassing":-2.0,"embrace":1.8,"emergency":-1.5,
  "emotional":-0.3,"empathy":1.8,"empower":1.8,"empowered":2.0,
  "empty":-0.8,"encourage":1.8,"encouraged":1.7,"encouraging":1.8,
  "endanger":-2.2,"endure":0.5,"enemy":-2.0,"energetic":1.5,"engage":1.0,
  "enjoy":2.2,"enjoyable":2.2,"enjoyment":2.2,"enormous":0.5,
  "enrage":-2.5,"enrich":1.8,"enthusiasm":2.0,"enthusiastic":2.2,
  "epidemic":-2.0,"equal":1.0,"equality":1.5,"error":-1.2,"escape":0.3,
  "essential":1.0,"esteem":1.5,"ethical":1.2,"evil":-3.0,"exaggerate":-1.2,
  "excellent":2.5,"exceptional":2.5,"excessive":-1.0,"excite":2.0,
  "excited":2.2,"exciting":2.3,"exclude":-1.2,"excuse":-0.5,
  "exhaust":-1.2,"exile":-1.8,"exploit":-1.8,"exploitation":-2.2,
  "explosion":-1.8,"expose":-0.8,"extraordinary":2.2,"extreme":-0.8,
  "extremism":-2.2,"extremist":-2.2,"fabulous":2.8,"fail":-2.0,
  "failed":-2.0,"failure":-2.2,"fair":1.5,"fairness":1.8,"faith":1.5,
  "faithful":1.8,"fake":-2.0,"fame":1.0,"famous":1.5,"fantastic":2.8,
  "fascinate":2.0,"fascinating":2.2,"fatal":-2.8,"fatality":-2.8,
  "fault":-1.5,"favor":1.2,"favorable":1.5,"fear":-2.0,"fearful":-2.0,
  "feasible":1.0,"fiasco":-2.5,"fierce":-1.0,"fight":-1.2,"fine":1.2,
  "flaw":-1.2,"flawed":-1.5,"flourish":2.0,"fool":-2.0,"foolish":-1.8,
  "forbid":-1.5,"force":-0.8,"forgive":1.5,"fortunate":1.8,"fortune":1.5,
  "foul":-2.2,"fraud":-2.8,"fraudulent":-2.8,"free":1.5,"freedom":2.0,
  "friendly":1.8,"frighten":-2.0,"frightening":-2.2,"frustrate":-1.8,
  "frustrated":-1.9,"frustrating":-2.0,"frustration":-2.0,"fulfill":2.0,
  "fun":2.2,"fundamental":0.5,"furious":-2.5,"generous":2.2,
  "gentle":1.5,"genuine":1.8,"glad":2.0,"glory":2.0,
  "good":1.9,"goodness":2.0,"grace":1.8,"graceful":2.0,"gracious":2.2,
  "grand":1.8,"grant":1.0,"grateful":2.2,"grave":-1.8,"greed":-2.5,
  "greedy":-2.2,"grief":-2.5,"grieve":-2.2,"grim":-2.0,"gross":-2.0,
  "groundbreaking":2.0,"guarantee":1.2,"guilt":-2.2,"guilty":-2.2,
  "happy":2.5,"happiness":2.8,"hard":-0.6,"hardship":-1.8,"harm":-2.2,
  "harmful":-2.2,"harmony":2.0,"harsh":-1.8,"hassle":-1.2,"hate":-2.8,
  "hatred":-3.0,"hazard":-1.8,"hazardous":-2.0,"heal":1.5,"health":1.0,
  "healthy":1.5,"heartbreak":-2.5,"heaven":1.8,"heavenly":2.5,
  "helpful":1.8,"helpless":-2.0,"hero":2.2,"heroic":2.5,"hesitant":-0.8,
  "highlight":0.5,"honest":1.8,"honesty":2.0,"honor":2.0,"honored":2.2,
  "hope":1.5,"hopeful":1.8,"hopeless":-2.2,"horrible":-2.8,"horrific":-3.0,
  "horrify":-2.8,"horror":-2.8,"hostile":-2.2,"hostility":-2.2,
  "huge":0.5,"humane":1.5,"humble":1.2,"humiliate":-2.5,"humiliation":-2.5,
  "humor":1.5,"hunger":-1.2,"hurt":-2.0,"ideal":1.8,"ignorance":-1.8,
  "ignorant":-2.0,"ignore":-1.2,"illegal":-2.0,"illegitimate":-2.0,
  "immoral":-2.5,"impact":-0.3,"impair":-1.5,"impartial":1.2,
  "impeach":-1.5,"impede":-1.2,"important":1.0,"impose":-1.0,
  "impossible":-1.5,"impress":1.8,"impressed":1.8,"impressive":2.2,
  "imprison":-2.0,"improve":1.5,"improvement":1.8,"inadequate":-1.5,
  "incompetent":-2.2,"incredible":2.3,"indifferent":-0.8,"inequality":-1.5,
  "infamous":-1.8,"inferior":-1.5,"inflame":-1.8,"influence":0.5,
  "influential":1.0,"inform":0.8,"inhuman":-3.0,"injure":-2.0,
  "injured":-2.0,"injury":-1.8,"injustice":-2.5,"innocent":1.0,
  "innovative":1.8,"insane":-2.0,"insecure":-1.5,"insensitive":-1.8,
  "inspire":2.2,"inspired":2.2,"inspiring":2.5,"insult":-2.2,
  "insulting":-2.5,"integrity":2.0,"intelligent":1.8,"intense":-0.3,
  "interest":1.0,"interesting":1.5,"interfere":-1.2,"intimidate":-2.0,
  "invade":-2.0,"invasion":-2.0,"invest":0.8,"investigate":0.3,
  "irrational":-1.5,"irresponsible":-2.0,"irritate":-1.5,"isolate":-1.2,
  "jealous":-1.8,"jeopardize":-2.0,"joy":2.5,"joyful":2.8,"judge":-0.5,
  "just":1.0,"justice":1.8,"justify":0.3,"keen":1.2,"kidnap":-2.8,
  "kill":-3.0,"killed":-3.0,"killing":-3.0,"kind":1.8,"kindness":2.2,
  "lack":-1.0,"lame":-1.5,"lament":-1.5,"laugh":1.5,"launch":0.5,
  "lawful":1.0,"lawless":-2.0,"lead":0.5,"leader":0.8,"legacy":0.8,
  "legal":0.5,"legitimate":1.0,"liberal":0.0,"liberate":1.8,"liberty":2.0,
  "lie":-2.5,"like":1.0,"limit":-0.5,"lonely":-1.8,"lose":-1.8,
  "loss":-2.0,"lost":-1.5,"love":2.5,"lovely":2.5,"loyal":1.8,
  "loyalty":2.0,"luck":1.5,"lucky":2.0,"mad":-1.8,"magnificent":2.8,
  "malicious":-2.8,"mandate":-0.3,"manipulate":-2.2,"manipulation":-2.2,
  "marvelous":2.8,"massacre":-3.5,"master":1.0,"meaningful":1.8,
  "menace":-2.2,"mercy":1.5,"merit":1.5,"mess":-1.5,"militant":-1.5,
  "miracle":2.5,"miserable":-2.5,"misery":-2.5,"mislead":-2.2,
  "misleading":-2.2,"miss":-0.8,"mistake":-1.5,"mistrust":-1.8,
  "mob":-1.8,"mock":-1.8,"modest":0.8,"moral":1.0,"mourn":-2.0,
  "murder":-3.5,"murdered":-3.5,"nasty":-2.5,"necessary":0.5,
  "negative":-1.5,"neglect":-1.8,"negligence":-1.8,"negligent":-1.8,
  "negotiate":0.5,"nervous":-1.2,"neutral":0.3,"nice":1.5,"noble":2.0,
  "nonsense":-1.8,"notorious":-1.8,"nurture":1.5,"object":-0.5,
  "objection":-1.0,"objective":0.8,"obligate":-0.5,"obscene":-2.5,
  "obstacle":-1.2,"offend":-2.0,"offensive":-2.2,"optimism":2.0,
  "optimistic":2.2,"oppress":-2.5,"oppression":-2.5,"oppose":-1.2,
  "opposition":-1.0,"ordeal":-2.0,"outstanding":2.5,"overcome":1.2,
  "overlook":-0.8,"overwhelm":-0.8,"pain":-2.2,"painful":-2.2,
  "panic":-2.0,"paradise":2.5,"pardon":0.8,"passion":1.8,"passionate":2.0,
  "patience":1.5,"patient":1.2,"patriot":1.2,"peace":2.0,"peaceful":2.2,
  "penalty":-1.5,"perfect":2.5,"peril":-2.2,"perilous":-2.2,
  "permit":0.5,"persecute":-2.8,"persecution":-2.8,"persist":0.5,
  "pessimistic":-1.8,"pity":-1.0,"plague":-2.2,"pleasant":1.8,
  "please":1.2,"pleased":1.8,"pleasure":2.2,"plunder":-2.5,"poison":-2.5,
  "polite":1.5,"pollute":-2.0,"pollution":-2.0,"poor":-1.5,"popular":1.2,
  "positive":1.5,"poverty":-2.0,"power":0.5,"powerful":1.0,
  "powerless":-1.8,"praise":2.2,"precious":2.0,"prejudice":-2.2,
  "preserve":1.2,"prevent":0.3,"pride":1.5,"privilege":1.2,
  "problem":-1.2,"profit":1.0,"progress":1.5,"prohibit":-1.0,
  "prominent":1.0,"promise":1.2,"promote":1.0,"proper":1.0,
  "prosper":2.0,"prosperity":2.2,"protect":1.5,"protection":1.5,
  "protest":-1.0,"proud":1.8,"provoke":-1.5,"punish":-1.8,
  "punishment":-1.8,"pure":1.5,"purpose":1.0,"quarrel":-1.5,
  "question":-0.3,"quiet":0.5,"racism":-3.0,"racist":-3.0,"rage":-2.5,
  "reckless":-2.0,"reconcile":1.5,"recover":1.2,"recovery":1.5,
  "reduce":-0.3,"reform":1.0,"refugee":-0.8,"refuse":-1.0,"regret":-1.5,
  "reject":-1.5,"rejected":-1.8,"rejoice":2.2,"relax":1.5,"release":0.5,
  "relevant":0.5,"reliable":1.5,"relief":1.5,"remarkable":2.2,
  "remedy":1.2,"remorse":-1.5,"renew":1.2,"repeal":-0.5,"repression":-2.5,
  "rescue":1.8,"resent":-2.0,"resentment":-2.0,"resist":-0.5,
  "resolve":1.2,"respect":1.8,"respected":2.0,"responsibility":1.0,
  "responsible":1.2,"restore":1.5,"restrain":-0.5,"restrict":-1.0,
  "restriction":-1.0,"retaliate":-1.5,"revenge":-2.0,"revolt":-1.5,
  "revolution":-0.5,"reward":1.8,"rich":1.0,"ridicule":-2.0,
  "ridiculous":-1.8,"right":0.8,"righteous":1.5,"rights":1.2,
  "rigid":-1.0,"riot":-2.2,"risk":-1.2,"rival":-0.8,"rob":-2.5,
  "ruin":-2.5,"ruined":-2.5,"ruthless":-2.8,"sacred":1.2,"sacrifice":0.5,
  "sad":-1.8,"sadness":-2.0,"safe":1.5,"safety":1.5,"sane":0.8,
  "satisfaction":2.0,"satisfactory":1.2,"satisfy":1.8,"savage":-2.8,
  "save":1.5,"scandal":-2.2,"scare":-1.8,"secure":1.5,"selfish":-2.0,
  "sensible":1.2,"sensitive":0.5,"serious":-0.5,"serve":0.8,
  "setback":-1.5,"severe":-1.8,"shame":-2.0,"shameful":-2.5,
  "shelter":1.0,"shock":-1.5,"shocking":-2.2,"sick":-1.5,"sin":-2.0,
  "sincere":1.8,"slaughter":-3.5,"slavery":-3.0,"smart":1.5,
  "smile":1.5,"solidarity":1.5,"solution":1.2,"solve":1.2,"sorrow":-2.0,
  "sorry":-1.0,"special":1.5,"spectacular":2.5,"spite":-1.8,
  "splendid":2.5,"stable":1.0,"steal":-2.2,"strength":1.5,"stress":-1.5,
  "strict":-0.5,"strike":-1.2,"strong":1.2,"struggle":-1.2,"stupid":-2.2,
  "submit":-0.5,"succeed":2.0,"success":2.2,"successful":2.2,
  "suffer":-2.2,"suffering":-2.5,"superb":2.8,"superior":1.5,
  "support":1.5,"suppress":-2.0,"suppression":-2.2,"sure":0.8,
  "surprise":0.5,"surrender":-1.2,"survive":0.8,"suspect":-1.0,
  "suspicion":-1.2,"suspicious":-1.5,"sustain":0.8,"sweet":1.5,
  "sympathy":1.5,"talent":1.8,"talented":2.0,"tension":-1.2,
  "terrible":-2.8,"terrify":-2.5,"terrifying":-2.8,"terror":-2.8,
  "terrorism":-3.0,"terrorist":-3.0,"thankful":2.0,"thankless":-1.2,
  "threat":-2.0,"threaten":-2.2,"thrive":2.0,"tolerate":0.5,
  "torture":-3.0,"toxic":-2.2,"tragedy":-2.5,"tragic":-2.5,
  "traitor":-2.8,"transparent":1.2,"trauma":-2.5,"traumatic":-2.5,
  "treasure":2.0,"tremendous":1.5,"triumph":2.5,"trouble":-1.5,
  "troubled":-1.5,"troubling":-1.8,"trust":1.8,"truth":1.5,
  "tyranny":-2.8,"ugly":-2.0,"unacceptable":-2.2,"unfair":-2.0,
  "unfortunate":-1.5,"unfortunately":-1.2,"unhappy":-1.8,"unjust":-2.2,
  "unlawful":-2.0,"unsafe":-2.0,"unstable":-1.5,"upset":-1.5,
  "urgent":-0.8,"useful":1.2,"useless":-1.8,"valuable":1.8,"value":1.2,
  "vanish":-0.8,"verdict":-0.3,"veto":-1.2,"vicious":-2.8,"victim":-2.0,
  "victory":2.5,"vigorous":1.5,"villain":-2.5,"vindicate":1.5,
  "violate":-2.5,"violation":-2.5,"violence":-2.8,"violent":-2.8,
  "virtue":1.8,"vital":1.2,"vulnerable":-1.2,"war":-2.5,"warn":-1.0,
  "warning":-1.2,"waste":-1.5,"weak":-1.5,"weakness":-1.5,"wealth":1.5,
  "weapon":-1.8,"welcome":1.8,"welfare":1.0,"wellbeing":2.0,
  "wicked":-2.8,"willing":1.2,"win":2.0,"wisdom":2.0,"wise":1.8,
  "wish":1.0,"wonderful":2.8,"worry":-1.5,"worse":-2.2,"worship":1.2,
  "worst":-2.5,"worth":1.2,"worthless":-2.5,"worthy":1.5,"wound":-2.0,
  "wrath":-2.8,"wreck":-2.0,"wrong":-1.8,"yield":0.3,"zealous":0.5
};

// ═══════════════════════════════════════════════════════════════════
// ANALYSIS FUNCTIONS
// ═══════════════════════════════════════════════════════════════════

function extractDomains(wikitext) {
  const re = /https?:\/\/([a-zA-Z0-9._-]+\.[a-zA-Z]{2,})/g;
  const domains = [];
  let m;
  while ((m = re.exec(wikitext)) !== null) {
    let d = m[1].toLowerCase();
    if (d.startsWith("www.")) d = d.slice(4);
    domains.push(d);
  }
  return domains;
}

// Try to match a domain or its parent domains against the ALLSIDES database
function matchDomain(d) {
  if (d in ALLSIDES) return d;
  // Try parent domains: e.g. "archive.nytimes.com" → "nytimes.com"
  const parts = d.split(".");
  for (let i = 1; i < parts.length - 1; i++) {
    const parent = parts.slice(i).join(".");
    if (parent in ALLSIDES) return parent;
  }
  return null;
}

function analyzeSourceBias(wikitext) {
  const domains = extractDomains(wikitext);
  const counts = {};
  domains.forEach(d => { counts[d] = (counts[d] || 0) + 1; });
  const classified = {}, unclassified = {};
  for (const [d, c] of Object.entries(counts)) {
    const matched = matchDomain(d);
    if (matched) {
      if (matched in classified) classified[matched].count += c;
      else classified[matched] = { count: c, rating: ALLSIDES[matched] };
    }
    else unclassified[d] = c;
  }
  const ratings = [];
  for (const [, info] of Object.entries(classified)) {
    for (let i = 0; i < info.count; i++) ratings.push(info.rating);
  }
  const totalC = ratings.length, totalU = Object.values(unclassified).reduce((a,b)=>a+b,0);
  if (ratings.length === 0) return { mean: null, median: null, std: null, label: "N/A", classified, unclassified, totalC, totalU, dist: {"-2":0,"-1":0,"0":0,"1":0,"2":0}, total: totalU };
  const mean = ratings.reduce((a,b)=>a+b,0) / ratings.length;
  const sorted = [...ratings].sort((a,b)=>a-b);
  const n = sorted.length;
  const median = n%2===1 ? sorted[Math.floor(n/2)] : (sorted[n/2-1]+sorted[n/2])/2;
  const variance = ratings.reduce((s,r) => s + (r-mean)**2, 0) / n;
  const std = Math.sqrt(variance);
  const dist = {"-2":0,"-1":0,"0":0,"1":0,"2":0};
  ratings.forEach(r => { dist[String(r)]++; });
  const roundedMean = Math.round(mean);
  const label = BIAS_LABELS[String(Math.max(-2, Math.min(2, roundedMean)))] || "Mixed";
  return { mean, median, std, label, classified, unclassified, totalC, totalU, dist, total: totalC + totalU };
}

function countPhrases(text, phrases) {
  const lower = text.toLowerCase();
  const matches = [];
  phrases.forEach(p => {
    const re = new RegExp("\\b" + p.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + "\\b", "gi");
    let m;
    while ((m = re.exec(lower)) !== null) matches.push(m[0]);
  });
  return matches;
}

function analyzePolicyCompliance(plainText) {
  const wc = plainText.split(/\s+/).length;
  const weasel = countPhrases(plainText, WEASEL);
  const peacock = countPhrases(plainText, PEACOCK);
  const editorial = countPhrases(plainText, EDITORIAL);
  const total = weasel.length + peacock.length + editorial.length;
  const freq = arr => { const c = {}; arr.forEach(w => { c[w]=(c[w]||0)+1; }); return Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,8); };
  return {
    weasel: { count: weasel.length, density: +(weasel.length/wc*1000).toFixed(1), examples: freq(weasel) },
    peacock: { count: peacock.length, density: +(peacock.length/wc*1000).toFixed(1), examples: freq(peacock) },
    editorial: { count: editorial.length, density: +(editorial.length/wc*1000).toFixed(1), examples: freq(editorial) },
    total: { count: total, density: +(total/wc*1000).toFixed(1) },
  };
}

function vaderScore(text) {
  const words = text.toLowerCase().replace(/[^a-z\s'-]/g, " ").split(/\s+/).filter(Boolean);
  let sum = 0, count = 0;
  words.forEach(w => {
    if (w in VADER_LEX) { sum += parseFloat(VADER_LEX[w]); count++; }
  });
  if (count === 0) return 0;
  const raw = sum / Math.sqrt(sum*sum + 15);
  return Math.max(-1, Math.min(1, raw));
}

function splitSentences(text) {
  return text.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 10);
}

function analyzeSentiment(sections) {
  const allScores = [];
  const sectionData = {};
  let bestPos = { text: "", score: -1, section: "" };
  let bestNeg = { text: "", score: 1, section: "" };
  for (const [name, text] of Object.entries(sections)) {
    const sents = splitSentences(text);
    if (!sents.length) continue;
    const scores = sents.map(s => vaderScore(s));
    scores.forEach((sc, i) => {
      allScores.push(sc);
      if (sc > bestPos.score) bestPos = { text: sents[i].slice(0,120), score: sc, section: name };
      if (sc < bestNeg.score) bestNeg = { text: sents[i].slice(0,120), score: sc, section: name };
    });
    const mean = scores.reduce((a,b)=>a+b,0)/scores.length;
    sectionData[name] = {
      mean, sentences: scores.length,
      posPct: +(scores.filter(s=>s>0.05).length/scores.length*100).toFixed(1),
      negPct: +(scores.filter(s=>s<-0.05).length/scores.length*100).toFixed(1),
      neuPct: +(scores.filter(s=>s>=-0.05&&s<=0.05).length/scores.length*100).toFixed(1),
    };
  }
  if (!allScores.length) return { mean:0, median:0, std:0, posPct:0, negPct:0, neuPct:0, sections:{}, bestPos, bestNeg, leadBodyGap:0, sectionVariance:0, totalSentences:0 };
  const n = allScores.length;
  const mean = allScores.reduce((a,b)=>a+b,0)/n;
  const sorted = [...allScores].sort((a,b)=>a-b);
  const median = n%2===1?sorted[Math.floor(n/2)]:(sorted[n/2-1]+sorted[n/2])/2;
  const std = Math.sqrt(allScores.reduce((s,v)=>s+(v-mean)**2,0)/n);
  const secMeans = Object.values(sectionData).map(s=>s.mean);
  const smMean = secMeans.reduce((a,b)=>a+b,0)/secMeans.length;
  const sectionVariance = secMeans.length > 1 ? secMeans.reduce((s,v)=>s+(v-smMean)**2,0)/secMeans.length : 0;
  const secNames = Object.keys(sectionData);
  const leadMean = sectionData[secNames[0]]?.mean || 0;
  const bodyMeans = secNames.slice(1).map(k => sectionData[k].mean);
  const bodyMean = bodyMeans.length ? bodyMeans.reduce((a,b)=>a+b,0)/bodyMeans.length : 0;
  return {
    mean, median, std, totalSentences: n,
    posPct: +(allScores.filter(s=>s>0.05).length/n*100).toFixed(1),
    negPct: +(allScores.filter(s=>s<-0.05).length/n*100).toFixed(1),
    neuPct: +(allScores.filter(s=>s>=-0.05&&s<=0.05).length/n*100).toFixed(1),
    sections: sectionData, bestPos, bestNeg,
    leadBodyGap: leadMean - bodyMean, sectionVariance,
  };
}

function analyzeStructure(sections, wikitext) {
  const sizes = {};
  let total = 0;
  for (const [name, text] of Object.entries(sections)) {
    const wc = text.split(/\s+/).length;
    sizes[name] = wc;
    total += wc;
  }
  const vals = Object.values(sizes).sort((a,b)=>a-b);
  const n = vals.length;
  let gini = 0;
  if (n > 1 && total > 0) {
    let num = 0;
    vals.forEach((v,i) => { num += (2*(i+1) - n - 1) * v; });
    gini = Math.abs(num / (n * total));
  }
  const largest = Object.entries(sizes).sort((a,b)=>b[1]-a[1])[0];
  const refTotal = (wikitext.match(/<ref/g) || []).length;
  const secLower = Object.keys(sections).map(s => s.toLowerCase());
  return {
    sections: n, totalWords: total, gini: +gini.toFixed(4),
    largest: largest ? { name: largest[0], pct: +(largest[1]/total*100).toFixed(1) } : { name: "", pct: 0 },
    hasCriticism: secLower.some(s => /criticism|controversy|opposition/.test(s)),
    hasReception: secLower.some(s => /reception|response|reaction/.test(s)),
    refTotal, refDensity: total > 0 ? +(refTotal/total*1000).toFixed(1) : 0,
    sectionSizes: sizes,
  };
}

function analyzeLexical(plainText) {
  const words = plainText.split(/\s+/);
  const wc = words.length;
  if (!wc) return {};
  const hedging = countPhrases(plainText, HEDGING).length;
  const intensifiers = countPhrases(plainText, INTENSIFIERS).length;
  const superlatives = countPhrases(plainText, SUPERLATIVES).length;
  const passiveRe = /\b(?:was|were|been|being|is|are)\s+(?:\w+ly\s+)?(?:\w+ed|made|done|seen|known|shown|held|told|found|built|sent|left|lost|kept|set)\b/gi;
  const passive = (plainText.match(passiveRe) || []).length;
  const unique = new Set(words.map(w => w.toLowerCase().replace(/[^a-z']/g,"")));
  const ttr = unique.size / wc;
  const freq = {};
  words.forEach(w => { const k = w.toLowerCase().replace(/[^a-z']/g,""); if(k) freq[k]=(freq[k]||0)+1; });
  const hapax = Object.values(freq).filter(c => c === 1).length;
  return {
    wordCount: wc, ttr: +ttr.toFixed(4), hapaxRatio: +(hapax/wc).toFixed(4),
    hedging: { count: hedging, density: +(hedging/wc*1000).toFixed(1) },
    intensifiers: { count: intensifiers, density: +(intensifiers/wc*1000).toFixed(1) },
    superlatives: { count: superlatives, density: +(superlatives/wc*1000).toFixed(1) },
    passive: { count: passive, density: +(passive/wc*1000).toFixed(1) },
  };
}

// ═══════════════════════════════════════════════════════════════════
// FRAMEWORK SCORING — Entman, Van Dijk, Gentzkow-Shapiro, Fairclough
// ═══════════════════════════════════════════════════════════════════

// ── Entman Framing (1993): Salience of problem/cause/moral/solution frames ──
const ENTMAN_LEFT_FRAMES = {
  problem: ["inequality","injustice","crisis","systemic","discrimination","exploitation","oppression","marginalized","disenfranchised","underrepresented","disparity","poverty","racism","sexism","xenophobia","homophobia","imperialism","colonialism","gentrification","austerity"],
  causal: ["corporate greed","systemic racism","deregulation","lack of funding","structural barriers","wealth gap","lobbying","corruption","capitalism","neoliberal","trickle-down","market failure","privatization"],
  moral: ["exploitative","discriminatory","unjust","unequal","inhumane","unconscionable","shameful","egregious","reprehensible","deplorable","harmful","toxic","oppressive"],
  solution: ["regulate","redistribute","invest in","public funding","social safety net","universal","equity","inclusion","reparation","progressive tax","living wage","collective bargaining","nationalize","subsidize"]
};
const ENTMAN_RIGHT_FRAMES = {
  problem: ["government overreach","wasteful spending","bureaucracy","dependency","illegal immigration","moral decline","lawlessness","socialism","radicalism","indoctrination","elitism","cancel culture","woke","political correctness"],
  causal: ["big government","welfare dependency","excessive regulation","high taxes","open borders","activist judges","liberal media","nanny state","entitlement mentality","union demands"],
  moral: ["irresponsible","wasteful","unconstitutional","un-american","radical","dangerous","reckless","unpatriotic","lawless","entitled","godless"],
  solution: ["deregulate","cut taxes","reduce government","personal responsibility","free market","privatize","secure borders","law and order","school choice","states rights","second amendment","protect liberty","traditional values"]
};

function analyzeEntmanFraming(plainText) {
  const lower = plainText.toLowerCase();
  let leftScore = 0, rightScore = 0;
  const weights = { problem: 1.0, causal: 1.2, moral: 1.5, solution: 1.0 };
  const details = { left: {}, right: {} };
  for (const [cat, phrases] of Object.entries(ENTMAN_LEFT_FRAMES)) {
    let count = 0;
    for (const p of phrases) { const re = new RegExp("\\b" + p.replace(/\s+/g, "\\s+") + "\\b", "gi"); const m = lower.match(re); if (m) count += m.length; }
    details.left[cat] = count;
    leftScore += count * weights[cat];
  }
  for (const [cat, phrases] of Object.entries(ENTMAN_RIGHT_FRAMES)) {
    let count = 0;
    for (const p of phrases) { const re = new RegExp("\\b" + p.replace(/\s+/g, "\\s+") + "\\b", "gi"); const m = lower.match(re); if (m) count += m.length; }
    details.right[cat] = count;
    rightScore += count * weights[cat];
  }
  const total = leftScore + rightScore;
  const score = total > 0 ? +((leftScore - rightScore) / total).toFixed(3) : 0;
  return { score, leftScore: +leftScore.toFixed(1), rightScore: +rightScore.toFixed(1), details, label: score > 0.3 ? "Left" : score > 0.1 ? "Moderate Left" : score < -0.3 ? "Right" : score < -0.1 ? "Moderate Right" : "Near Neutral" };
}

// ── Van Dijk Ideological Square (1998): Us/Them polarization ──
const POSITIVE_DESCRIPTORS = ["democratic","freedom","liberty","innovation","progress","prosperity","security","justice","equality","fairness","compassion","brave","courageous","principled","responsible","legitimate","peaceful","stable","civilized","advanced","protective","heroic","visionary","dedicated","transparent"];
const NEGATIVE_DESCRIPTORS = ["corrupt","reckless","dangerous","dishonest","destructive","extremist","radical","authoritarian","tyrannical","barbaric","threatening","aggressive","incompetent","illegitimate","destabilizing","violent","backward","repressive","deceitful","manipulative","fanatical","hostile","divisive","rogue"];
const US_MARKERS = ["we","our","us","ourselves","our country","our nation","our people","our society","the people","citizens","allies","the west","western","homeland","domestic","national"];
const THEM_MARKERS = ["they","their","them","those","enemy","enemies","opponents","adversaries","foreigners","outsiders","regime","militant","insurgent","terrorist","extremist","alien","invader"];

function analyzeVanDijk(plainText) {
  const lower = plainText.toLowerCase();
  const sentences = plainText.split(/[.!?]+/).filter(s => s.trim().length > 10);
  let usPositive = 0, usNegative = 0, themPositive = 0, themNegative = 0;
  for (const sent of sentences) {
    const sl = sent.toLowerCase();
    const hasUs = US_MARKERS.some(m => new RegExp("\\b" + m + "\\b", "i").test(sl));
    const hasThem = THEM_MARKERS.some(m => new RegExp("\\b" + m + "\\b", "i").test(sl));
    const posCount = POSITIVE_DESCRIPTORS.filter(w => new RegExp("\\b" + w + "\\b", "i").test(sl)).length;
    const negCount = NEGATIVE_DESCRIPTORS.filter(w => new RegExp("\\b" + w + "\\b", "i").test(sl)).length;
    if (hasUs) { usPositive += posCount; usNegative += negCount; }
    if (hasThem) { themPositive += posCount; themNegative += negCount; }
  }
  const idealSquare = (usPositive + themNegative) - (usNegative + themPositive);
  const total = usPositive + usNegative + themPositive + themNegative;
  const score = total > 0 ? +(idealSquare / total).toFixed(3) : 0;
  const polarization = total > 0 ? +((usPositive + themNegative) / total).toFixed(3) : 0;
  return {
    score, polarization, usPositive, usNegative, themPositive, themNegative, totalMarkers: total,
    label: Math.abs(score) < 0.1 ? "Balanced" : Math.abs(score) < 0.3 ? "Moderate Polarization" : "High Polarization"
  };
}

// ── Gentzkow-Shapiro Slant (2010): Partisan phrase frequency ──
const PARTISAN_LEFT = [
  "estate tax","climate change","gun violence","gun safety","reproductive rights","reproductive freedom","undocumented immigrants","undocumented workers","affordable care act","marriage equality","income inequality","wealth gap","racial justice","social justice","systemic racism","voter suppression","living wage","workers rights","collective bargaining","public option","single payer","universal healthcare","green new deal","assault weapons","common sense gun","racial profiling","mass incarceration","clean energy","renewable energy","carbon emissions","fossil fuel","gender pay gap","wage theft","predatory lending","food insecurity","housing crisis","police brutality","white supremacy","white nationalism","glass ceiling","indigenous peoples","environmental justice","intersectionality","microaggression","cultural appropriation","disinformation","misinformation","dark money","corporate welfare"
];
const PARTISAN_RIGHT = [
  "death tax","energy independence","second amendment","right to bear arms","pro-life","unborn children","illegal aliens","illegal immigrants","obamacare","traditional marriage","free market","job creators","job killing","religious liberty","religious freedom","law and order","personal responsibility","welfare reform","government overreach","school choice","right to work","tax relief","tax burden","fiscal responsibility","national defense","border security","secure the border","radical left","liberal elite","deep state","big government","entitlement reform","government waste","taxpayer dollars","hard working americans","family values","american exceptionalism","political correctness","cancel culture","woke","virtue signaling","mainstream media","fake news","judicial activism","activist judges","states rights","god given rights","founding fathers","constitutional rights","sanctity of life"
];

function analyzeGentzkowShapiro(plainText) {
  const lower = plainText.toLowerCase();
  let leftCount = 0, rightCount = 0;
  const leftFound = [], rightFound = [];
  for (const phrase of PARTISAN_LEFT) {
    const re = new RegExp("\\b" + phrase.replace(/\s+/g, "\\s+") + "\\b", "gi");
    const m = lower.match(re);
    if (m) { leftCount += m.length; leftFound.push({ phrase, count: m.length }); }
  }
  for (const phrase of PARTISAN_RIGHT) {
    const re = new RegExp("\\b" + phrase.replace(/\s+/g, "\\s+") + "\\b", "gi");
    const m = lower.match(re);
    if (m) { rightCount += m.length; rightFound.push({ phrase, count: m.length }); }
  }
  const total = leftCount + rightCount;
  const score = total > 0 ? +((leftCount - rightCount) / total).toFixed(3) : 0;
  return {
    score, leftCount, rightCount, total,
    leftFound: leftFound.sort((a, b) => b.count - a.count).slice(0, 10),
    rightFound: rightFound.sort((a, b) => b.count - a.count).slice(0, 10),
    label: score > 0.3 ? "Left" : score > 0.1 ? "Moderate Left" : score < -0.3 ? "Right" : score < -0.1 ? "Moderate Right" : "Near Neutral"
  };
}

// ── Fairclough CDA (1995): Linguistic power/ideology markers ──
function analyzeFairlough(plainText) {
  const words = plainText.split(/\s+/);
  const wc = words.length;
  if (!wc) return { score: 0, label: "N/A" };

  // 1. Passive voice ratio (obscures agency)
  const passiveRe = /\b(?:was|were|been|being|is|are|has been|have been|had been)\s+(?:\w+ly\s+)?(?:\w+ed|made|done|seen|known|shown|held|told|found|built|sent|left|lost|kept|set|given|taken|brought|thought|said|written|broken|chosen|spoken|driven|forgotten|hidden|risen|shaken|stolen|sworn|torn|worn|born|drawn|grown|thrown|woken)\b/gi;
  const passiveCount = (plainText.match(passiveRe) || []).length;
  const passiveRatio = passiveCount / (wc / 100);

  // 2. Nominalization (converting processes to things — obscures agency)
  const nomSuffixes = /\b\w{4,}(?:tion|sion|ment|ness|ance|ence|ity|ism|ist|age)\b/gi;
  const nomCount = (plainText.match(nomSuffixes) || []).length;
  const nomRatio = nomCount / (wc / 100);

  // 3. Modality — hedging vs assertive (epistemic stance)
  const highCertainty = ["must","certainly","definitely","undoubtedly","clearly","obviously","absolutely","inevitably","unquestionably","always","never"];
  const lowCertainty = ["may","might","could","possibly","perhaps","arguably","seemingly","apparently","allegedly","reportedly","supposedly","presumably"];
  let highCount = 0, lowCount = 0;
  for (const w of highCertainty) { const re = new RegExp("\\b" + w + "\\b", "gi"); highCount += (plainText.match(re) || []).length; }
  for (const w of lowCertainty) { const re = new RegExp("\\b" + w + "\\b", "gi"); lowCount += (plainText.match(re) || []).length; }
  const modalityBalance = (highCount + lowCount) > 0 ? (highCount - lowCount) / (highCount + lowCount) : 0;

  // 4. Presupposition triggers (present assumptions as fact)
  const presupTriggers = ["the fact that","it is clear that","it is obvious that","it is well known","everyone knows","as we all know","of course","naturally","needless to say","it goes without saying","given that","since"];
  let presupCount = 0;
  for (const p of presupTriggers) { const re = new RegExp(p.replace(/\s+/g, "\\s+"), "gi"); presupCount += (plainText.match(re) || []).length; }

  // 5. Evaluative adjectives (value-laden language)
  const evalAdj = ["important","significant","crucial","essential","vital","remarkable","extraordinary","notable","profound","exceptional","controversial","problematic","alarming","dangerous","threatening","devastating","disastrous","unprecedented","historic","revolutionary","progressive","regressive","radical","moderate","extreme"];
  let evalCount = 0;
  for (const w of evalAdj) { const re = new RegExp("\\b" + w + "\\b", "gi"); evalCount += (plainText.match(re) || []).length; }
  const evalDensity = evalCount / (wc / 1000);

  // Composite CDA score: higher = more ideologically loaded language
  // Normalize each component to 0-1, then average
  const passiveNorm = Math.min(passiveRatio / 5, 1);
  const nomNorm = Math.min(nomRatio / 15, 1);
  const modalNorm = (modalityBalance + 1) / 2; // -1..1 → 0..1
  const presupNorm = Math.min(presupCount / (wc / 2000), 1);
  const evalNorm = Math.min(evalDensity / 20, 1);

  const composite = +(((passiveNorm + nomNorm + modalNorm + presupNorm + evalNorm) / 5) * 2 - 1).toFixed(3);
  // Scale: -1 (highly transparent/neutral) to +1 (highly ideological/loaded)

  return {
    score: composite,
    passiveRatio: +passiveRatio.toFixed(2),
    nomRatio: +nomRatio.toFixed(2),
    modalityBalance: +modalityBalance.toFixed(3),
    presupCount,
    evalDensity: +evalDensity.toFixed(1),
    highCertaintyCount: highCount,
    lowCertaintyCount: lowCount,
    passiveCount,
    nomCount,
    evalCount,
    label: Math.abs(composite) < 0.15 ? "Neutral Discourse" : Math.abs(composite) < 0.35 ? "Moderate Ideology" : "Strong Ideology"
  };
}

// ═══════════════════════════════════════════════════════════════════
// WIKITEXT PARSING
// ═══════════════════════════════════════════════════════════════════

function parseWikitext(wikitext) {
  const sections = {};
  let current = "Lead";
  let buffer = [];
  const lines = wikitext.split("\n");
  const skip = new Set(["see also","references","external links","further reading","notes","citations","bibliography","sources"]);
  for (const line of lines) {
    const hm = line.match(/^(={2,})\s*(.+?)\s*\1/);
    if (hm) {
      const text = stripWikiMarkup(buffer.join("\n"));
      if (text.trim() && !skip.has(current.toLowerCase())) sections[current] = text;
      current = hm[2].replace(/\[.*?\]/g,"").trim();
      buffer = [];
    } else {
      buffer.push(line);
    }
  }
  const text = stripWikiMarkup(buffer.join("\n"));
  if (text.trim() && !skip.has(current.toLowerCase())) sections[current] = text;
  return sections;
}

function stripWikiMarkup(text) {
  let t = text;
  t = t.replace(/<ref[^>]*\/>/g, "");
  t = t.replace(/<ref[^>]*>[\s\S]*?<\/ref>/g, "");
  t = t.replace(/<!--[\s\S]*?-->/g, "");
  t = t.replace(/\{\{[^{}]*\}\}/g, "");
  t = t.replace(/\{\{[^{}]*\}\}/g, "");
  t = t.replace(/\[\[(?:[^\]|]*\|)?([^\]]*)\]\]/g, "$1");
  t = t.replace(/\[https?:\/\/[^\s\]]+\s*([^\]]*)\]/g, "$1");
  t = t.replace(/'{2,3}/g, "");
  t = t.replace(/<[^>]+>/g, "");
  t = t.replace(/\s+/g, " ");
  return t.trim();
}

// ═══════════════════════════════════════════════════════════════════
// VISUAL COMPONENTS
// ═══════════════════════════════════════════════════════════════════

function BiasSpectrum({ mean, dist }) {
  if (mean === null) return <div className="desc" style={{fontStyle:"italic"}}>No classified sources found</div>;
  const total = Object.values(dist).reduce((a,b)=>a+b,0);
  const pos = ((mean + 2) / 4) * 100;
  return (
    <div style={{display:"flex",flexDirection:"column",gap:"12px"}}>
      <div className="spectrum-bar">
        <div className="spectrum-marker" style={{ left: `${Math.max(1,Math.min(99,pos))}%` }} />
        <div className="spectrum-labels">
          <span>Left</span><span>Lean L</span><span>Center</span><span>Lean R</span><span>Right</span>
        </div>
      </div>
      <div className="dist-bar-row">
        {["-2","-1","0","1","2"].map(k => {
          const pct = total > 0 ? (dist[k]/total)*100 : 0;
          return (
            <div key={k} className="dist-col">
              <div className="dist-fill" style={{ height: `${Math.max(3, pct)}%`, minHeight: pct > 0 ? 4 : 2, backgroundColor: BIAS_COLORS[k] }} />
              <span className="dist-count">{dist[k]}</span>
            </div>
          );
        })}
      </div>
      <div className="dist-labels">
        <span>Left</span><span>Lean Left</span><span>Center</span><span>Lean Right</span><span>Right</span>
      </div>
    </div>
  );
}

function MetricBar({ label, value, max, color = "#3b82f6", suffix = "" }) {
  const pct = max > 0 ? Math.min(100, (value / max) * 100) : 0;
  return (
    <div className="metric-row">
      <span className="metric-label">{label}</span>
      <div className="metric-track">
        <div className="metric-fill" style={{ width: `${pct}%`, backgroundColor: color }} />
      </div>
      <span className="metric-value">{value}{suffix}</span>
    </div>
  );
}

function SentimentBar({ name, data }) {
  const clr = data.mean > 0.05 ? "#22c55e" : data.mean < -0.05 ? "#ef4444" : "#a3a3a3";
  return (
    <div className="sent-row">
      <span className="sent-name" title={name}>{name}</span>
      <div className="sent-track">
        <div className="sent-center" />
        {data.mean !== 0 && (
          <div className="sent-fill" style={{
            left: data.mean > 0 ? "50%" : `${50 + data.mean * 50}%`,
            width: `${Math.abs(data.mean) * 50}%`,
            backgroundColor: clr,
          }} />
        )}
      </div>
      <span className="sent-val" style={{ color: clr }}>
        {data.mean > 0 ? "+" : ""}{data.mean.toFixed(3)}
      </span>
    </div>
  );
}

function Section({ title, icon, children, defaultOpen = true, sources }) {
  const [open, setOpen] = useState(defaultOpen);
  const [showSources, setShowSources] = useState(false);
  return (
    <div className="card">
      <button className="section-header" onClick={() => setOpen(!open)}>
        <span className="section-icon">{icon}</span>
        <span className="section-title">{title}</span>
        {sources && (
          <span onClick={e => { e.stopPropagation(); setShowSources(!showSources); }} title="View databases & sources consulted" style={{fontSize:"13px",color:"#0d7680",marginLeft:"8px",textDecoration:"underline",cursor:"pointer",fontWeight:400}}>{showSources ? "hide sources" : "sources"}</span>
        )}
        <span className="section-toggle">{open ? "\u25B2" : "\u25BC"}</span>
      </button>
      {showSources && sources && (
        <div style={{background:"#f6f1eb",borderBottom:"1px solid #e8d5c4",padding:"12px 20px",fontSize:"13px",lineHeight:1.7}}>
          <div style={{fontWeight:700,color:"#33302e",marginBottom:"6px",fontFamily:"'Playfair Display', serif",fontSize:"14px"}}>Databases &amp; Sources Consulted</div>
          {sources.map((s, i) => (
            <div key={i} style={{marginBottom:"4px",display:"flex",gap:"6px"}}>
              <span style={{color:"#990f3d",fontWeight:700}}>{"\u2022"}</span>
              <span>{s.url ? <a href={s.url} target="_blank" rel="noopener" style={{color:"#0d7680",textDecoration:"underline"}}>{s.name}</a> : <strong>{s.name}</strong>}{s.detail && <span style={{color:"#66605c"}}> — {s.detail}</span>}</span>
            </div>
          ))}
        </div>
      )}
      {open && <div className="section-body">{children}</div>}
    </div>
  );
}

function Stat({ label, value, sub }) {
  return (
    <div className="stat">
      <div className="stat-value">{value}</div>
      <div className="stat-label">{label}</div>
      {sub && <div className="stat-sub">{sub}</div>}
    </div>
  );
}

function highlightText(text, weaselPhrases, peacockPhrases, editorialPhrases) {
  // Build a combined list of all phrases with their types, sorted longest-first to avoid partial matches
  const allPhrases = [
    ...weaselPhrases.map(p => ({ phrase: p, type: "weasel" })),
    ...peacockPhrases.map(p => ({ phrase: p, type: "peacock" })),
    ...editorialPhrases.map(p => ({ phrase: p, type: "editorial" })),
  ].sort((a, b) => b.phrase.length - a.phrase.length);

  if (allPhrases.length === 0) return [text];

  // Build regex that matches any phrase
  const escaped = allPhrases.map(p => p.phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
  const re = new RegExp("\\b(" + escaped.join("|") + ")\\b", "gi");

  // Build a type lookup
  const typeLookup = {};
  allPhrases.forEach(p => { typeLookup[p.phrase.toLowerCase()] = p.type; });

  const parts = [];
  let last = 0;
  let match;
  while ((match = re.exec(text)) !== null) {
    if (match.index > last) parts.push({ text: text.slice(last, match.index), type: null });
    const matchedType = typeLookup[match[0].toLowerCase()] || "weasel";
    parts.push({ text: match[0], type: matchedType });
    last = re.lastIndex;
  }
  if (last < text.length) parts.push({ text: text.slice(last), type: null });
  return parts;
}

const HIGHLIGHT_COLORS = {
  weasel: { bg: "#fef3c7", border: "#f59e0b", label: "Weasel" },
  peacock: { bg: "#ede9fe", border: "#8b5cf6", label: "Peacock" },
  editorial: { bg: "#fee2e2", border: "#ef4444", label: "Editorial" },
};

function PolicySection({ policy, sections }) {
  const [showText, setShowText] = useState(false);

  return (
    <Section title="Wikipedia Policy Compliance" icon={"\uD83D\uDCCB"} sources={[
      {name:"Wikipedia:Manual of Style/Words to watch",url:"https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style/Words_to_watch",detail:"Official Wikipedia word lists for weasel, peacock, and editorializing terms"},
      {name:"WP:WEASEL — Unsupported attributions",url:"https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style/Words_to_watch#Unsupported_attributions",detail:"14 phrase patterns (e.g., 'some people say', 'it is believed', 'experts claim')"},
      {name:"WP:PEACOCK — Puffery",url:"https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style/Words_to_watch#Puffery",detail:"11 superlative/promotional terms (e.g., 'legendary', 'renowned', 'prestigious')"},
      {name:"WP:EDITORIALIZING",url:"https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style/Words_to_watch#Editorializing",detail:"10 opinion-marker phrases (e.g., 'of course', 'notably', 'it should be noted')"},
    ]}>
      <p className="desc">Text scanned against Wikipedia's own <a href="https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style/Words_to_watch#Unsupported_attributions" target="_blank" rel="noopener" style={{color:"#0d7680"}}>WP:WEASEL</a>, <a href="https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style/Words_to_watch#Puffery" target="_blank" rel="noopener" style={{color:"#0d7680"}}>WP:PEACOCK</a>, and <a href="https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style/Words_to_watch#Editorializing" target="_blank" rel="noopener" style={{color:"#0d7680"}}>WP:EDITORIALIZING</a> word lists.</p>
      <div className="stats-grid stats-4">
        <Stat label="Total Flags" value={policy.total.count} sub={`${policy.total.density}/1k words`} />
        <Stat label="Weasel" value={policy.weasel.count} sub={`${policy.weasel.density}/1k`} />
        <Stat label="Peacock" value={policy.peacock.count} sub={`${policy.peacock.density}/1k`} />
        <Stat label="Editorial" value={policy.editorial.count} sub={`${policy.editorial.density}/1k`} />
      </div>
      <MetricBar label="Weasel Words" value={policy.weasel.density} max={15} color="#f59e0b" suffix="/1k" />
      <MetricBar label="Peacock Terms" value={policy.peacock.density} max={15} color="#8b5cf6" suffix="/1k" />
      <MetricBar label="Editorializing" value={policy.editorial.density} max={15} color="#ef4444" suffix="/1k" />
      {[["Weasel",policy.weasel],["Peacock",policy.peacock],["Editorial",policy.editorial]].map(([name, data]) =>
        data.examples.length > 0 && (
          <div key={name} className="example-line">
            <span className="example-bold">{name}:</span> {data.examples.map(([w,c]) => `"${w}" (${c})`).join(", ")}
          </div>
        )
      )}

      {showText && sections && (
        <div style={{marginTop:"12px"}}>
          <div style={{display:"flex",gap:"12px",marginBottom:"8px",flexWrap:"wrap"}}>
            {Object.entries(HIGHLIGHT_COLORS).map(([type, c]) => (
              <span key={type} style={{fontSize:"12px",display:"flex",alignItems:"center",gap:"4px"}}>
                <span style={{display:"inline-block",width:"14px",height:"14px",backgroundColor:c.bg,border:`2px solid ${c.border}`,borderRadius:"3px"}} />
                {c.label}
              </span>
            ))}
          </div>
          <div style={{maxHeight:"500px",overflowY:"auto",border:"1px solid #e8d5c4",borderRadius:"0",padding:"16px",backgroundColor:"#fff",fontSize:"14px",lineHeight:"1.7"}}>
            {Object.entries(sections).map(([sectionName, text]) => {
              if (!text.trim()) return null;
              const parts = highlightText(text, WEASEL, PEACOCK, EDITORIAL);
              const hasHighlights = parts.some(p => p.type);
              return (
                <div key={sectionName} style={{marginBottom:"16px"}}>
                  <div style={{fontWeight:700,fontSize:"15px",color:"#33302e",fontFamily:"'Playfair Display', Georgia, serif",marginBottom:"4px",borderBottom:"1px solid #e8d5c4",paddingBottom:"4px"}}>{sectionName}</div>
                  <div style={{color:"#334155"}}>
                    {parts.map((p, i) => p.type ? (
                      <span key={i} title={HIGHLIGHT_COLORS[p.type].label} style={{
                        backgroundColor: HIGHLIGHT_COLORS[p.type].bg,
                        borderBottom: `2px solid ${HIGHLIGHT_COLORS[p.type].border}`,
                        borderRadius: "2px",
                        padding: "0 2px",
                        cursor: "help",
                      }}>{p.text}</span>
                    ) : <span key={i}>{p.text}</span>)}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {policy.total.count > 0 && (
        <button onClick={() => setShowText(!showText)} style={{
          marginTop:"10px",background:"none",border:"1px solid #ccc1b7",borderRadius:"0",
          padding:"8px 14px",fontSize:"13px",color:"#33302e",cursor:"pointer",width:"100%",fontFamily:"'Source Sans 3', sans-serif"
        }}>
          {showText ? "\u25B2 Hide highlighted text" : "\u25BC View article with highlights"}
        </button>
      )}
    </Section>
  );
}

function detectProvider(key) {
  const k = key.trim();
  if (k.startsWith("AIza")) return "gemini";
  if (k.startsWith("sk-ant-")) return "anthropic";
  if (k.startsWith("gsk_")) return "groq";
  if (k.startsWith("sk-")) return "openai";
  return null;
}

const PROVIDER_INFO = {
  gemini:    { name: "Gemini", model: "gemini-2.0-flash", color: "#4285f4" },
  openai:    { name: "OpenAI", model: "gpt-4o-mini", color: "#10a37f" },
  anthropic: { name: "Anthropic", model: "claude-sonnet-4-20250514", color: "#d4a27f" },
  groq:      { name: "Groq", model: "llama-3.1-70b-versatile", color: "#f55036" },
};

function LLMAnalysisSection({ plainText, title }) {
  const [apiKey, setApiKey] = useState("");
  const [llmResult, setLlmResult] = useState(null);
  const [llmLoading, setLlmLoading] = useState(false);
  const [llmError, setLlmError] = useState(null);

  const detected = detectProvider(apiKey);

  const prompt = `You are a media bias analyst. Analyze the following Wikipedia article for bias.

Article title: "${title}"

Article text (truncated to fit context):
${plainText.slice(0, 6000)}

Provide a structured analysis covering:
1. OVERALL BIAS ASSESSMENT: Rate the article on a scale from -5 (strong left bias) to +5 (strong right bias), with 0 being neutral. Explain your rating.
2. FRAMING ANALYSIS: How is the subject framed? Are there notable omissions or emphasis patterns?
3. LANGUAGE BIAS: Identify specific phrases or word choices that suggest bias.
4. SOURCE BALANCE: Based on the text, does the article appear to draw from diverse perspectives?
5. COMPARISON WITH RULE-BASED ANALYSIS: Note that our deterministic tool found the following - provide your LLM-based perspective on whether these findings are meaningful.

Be specific and cite examples from the text. Be balanced in your own assessment.`;

  const runLLM = async () => {
    if (!apiKey.trim()) { setLlmError("Please paste an API key."); return; }
    if (!detected) { setLlmError("Unrecognized key format. Supported: Gemini (AIza...), OpenAI (sk-...), Anthropic (sk-ant-...), Groq (gsk_...)."); return; }
    const info = PROVIDER_INFO[detected];
    setLlmLoading(true);
    setLlmError(null);
    setLlmResult(null);

    try {
      let response, data;
      if (detected === "gemini") {
        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${info.model}:generateContent?key=${apiKey}`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { maxOutputTokens: 2000 } })
        });
        data = await response.json();
        if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
        if (!data.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("No response generated. Check your API key and try again.");
        setLlmResult(data.candidates[0].content.parts[0].text);
      } else if (detected === "anthropic") {
        response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-api-key": apiKey, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
          body: JSON.stringify({ model: info.model, max_tokens: 2000, messages: [{ role: "user", content: prompt }] })
        });
        data = await response.json();
        if (data.error) throw new Error(data.error.message);
        setLlmResult(data.content[0].text);
      } else {
        const endpoint = detected === "groq" ? "https://api.groq.com/openai/v1/chat/completions" : "https://api.openai.com/v1/chat/completions";
        response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
          body: JSON.stringify({ model: info.model, messages: [{ role: "user", content: prompt }], max_tokens: 2000 })
        });
        data = await response.json();
        if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
        setLlmResult(data.choices[0].message.content);
      }
    } catch (e) {
      setLlmError(e.message);
    }
    setLlmLoading(false);
  };

  return (
    <Section title="AI-Powered Analysis (Optional)" icon={"\uD83E\uDD16"} defaultOpen={false} sources={[
      {name:"Google Gemini API",url:"https://aistudio.google.com/apikey",detail:"gemini-2.0-flash model via REST API"},
      {name:"OpenAI API",url:"https://platform.openai.com/api-keys",detail:"gpt-4o-mini model"},
      {name:"Anthropic API",url:"https://console.anthropic.com/settings/keys",detail:"claude-sonnet-4-20250514 model"},
      {name:"Groq API",url:"https://console.groq.com/keys",detail:"llama-3.1-70b-versatile model via Groq inference"},
    ]}>
      <p className="desc">Paste any LLM API key to get an AI-generated bias analysis. Provider is auto-detected from the key. Your key is never stored. Supports <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Gemini</a>, <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener" style={{color:"#0d7680"}}>OpenAI</a>, <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Anthropic</a>, <a href="https://console.groq.com/keys" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Groq</a>.</p>
      <div style={{display:"flex",gap:"8px"}}>
        <div style={{flex:1,position:"relative"}}>
          <input type="password" value={apiKey} onChange={e => { setApiKey(e.target.value); setLlmError(null); }} placeholder="Paste any API key (Gemini, OpenAI, Anthropic, or Groq)..."
            onKeyDown={e => { if (e.key === "Enter" && apiKey.trim()) runLLM(); }}
            style={{width:"100%",padding:"10px 14px",paddingRight: detected ? "120px" : "14px",border:"1px solid #ccc1b7",fontSize:"14px",fontFamily:"'Source Sans 3', sans-serif",background:"#fff",color:"#33302e"}} />
          {detected && (
            <span style={{position:"absolute",right:"10px",top:"50%",transform:"translateY(-50%)",fontSize:"12px",fontWeight:600,color:PROVIDER_INFO[detected].color,background:"#fff",padding:"2px 8px",border:`1px solid ${PROVIDER_INFO[detected].color}`,letterSpacing:"0.03em"}}>
              {PROVIDER_INFO[detected].name} &middot; {PROVIDER_INFO[detected].model}
            </span>
          )}
        </div>
        <button onClick={runLLM} disabled={llmLoading || !apiKey.trim() || !detected} className="btn-primary" style={{whiteSpace:"nowrap"}}>
          {llmLoading ? "Analyzing..." : "Run Analysis"}
        </button>
      </div>
      {llmError && <div style={{color:"#990f3d",fontSize:"13px",padding:"8px 12px",background:"#fdf5f5",border:"1px solid #990f3d"}}>{llmError}</div>}
      {llmResult && (
        <div style={{background:"#fff",border:"1px solid #e8d5c4",padding:"16px",fontSize:"14px",lineHeight:"1.7",color:"#33302e",whiteSpace:"pre-wrap",maxHeight:"600px",overflowY:"auto"}}>
          {llmResult}
        </div>
      )}
    </Section>
  );
}

function SourceBiasSection({ sb, topSources, allClassified, allUnclassified }) {
  const [showAll, setShowAll] = useState(false);
  const totalDomains = allClassified.length + allUnclassified.length;
  return (
    <Section title="Source Bias Profile" icon={"\uD83D\uDCF0"} sources={[
      {name:"AllSides Media Bias Ratings v11 (Dec 2025)",url:"https://www.allsides.com/media-bias/ratings",detail:"219 outlets rated Left to Right via blind surveys, editorial reviews, and third-party research"},
      {name:"Media Bias/Fact Check (MBFC)",url:"https://mediabiasfactcheck.com/",detail:"Used for international and Indian outlets not rated by AllSides"},
      {name:"Custom institutional classification",detail:"23 archival/reference domains (archive.org, nobelprize.org, smithsonianmag.com, etc.) rated Center"},
      {name:"Wikipedia API",url:"https://en.wikipedia.org/w/api.php",detail:"Wikitext parsed for <ref> tags and external URLs; subdomain fallback matching applied"},
    ]}>
      <p className="desc">Cited domains mapped to AllSides media bias ratings. Scale: -2 (Left) to +2 (Right).</p>
      <div className="stats-grid stats-4">
        <Stat label="Mean Bias" value={sb.mean !== null ? (sb.mean > 0 ? "+" : "") + sb.mean.toFixed(2) : "N/A"} sub={sb.label} />
        <Stat label="Sources" value={sb.total || (sb.totalC + sb.totalU)} />
        <Stat label="Classified" value={`${sb.totalC} (${sb.total ? Math.round(sb.totalC/sb.total*100) : 0}%)`} />
        <Stat label="Unique Domains" value={totalDomains} />
      </div>
      <BiasSpectrum mean={sb.mean} dist={sb.dist} />

      {!showAll && topSources.length > 0 && (
        <div>
          <div className="small-title">Top Cited Sources</div>
          <div style={{display:"flex",flexDirection:"column",gap:"4px"}}>
            {topSources.map(([domain, info]) => (
              <div key={domain} className="source-row">
                <div className="source-dot" style={{ backgroundColor: BIAS_COLORS[String(info.rating)] }} />
                <span className="source-domain">{domain}</span>
                <span className="source-rating">{BIAS_LABELS[String(info.rating)]}</span>
                <span className="source-count">{info.count}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {showAll && (
        <div>
          {allClassified.length > 0 && (
            <div>
              <div className="small-title" style={{marginBottom:"6px"}}>Classified Sources ({allClassified.length} domains, {sb.totalC} citations)</div>
              <div style={{display:"flex",flexDirection:"column",gap:"3px",maxHeight:"400px",overflowY:"auto",padding:"0 4px"}}>
                {allClassified.map(([domain, info]) => (
                  <div key={domain} className="source-row">
                    <div className="source-dot" style={{ backgroundColor: BIAS_COLORS[String(info.rating)] }} />
                    <span className="source-domain">{domain}</span>
                    <span className="source-rating">{BIAS_LABELS[String(info.rating)]}</span>
                    <span className="source-count">{info.count}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
          {allUnclassified.length > 0 && (
            <div style={{marginTop:"12px"}}>
              <div className="small-title" style={{marginBottom:"6px"}}>Unclassified Sources ({allUnclassified.length} domains, {sb.totalU} citations)</div>
              <div style={{display:"flex",flexDirection:"column",gap:"3px",maxHeight:"300px",overflowY:"auto",padding:"0 4px"}}>
                {allUnclassified.map(([domain, count]) => (
                  <div key={domain} className="source-row">
                    <div className="source-dot" style={{ backgroundColor: "#e2e8f0" }} />
                    <span className="source-domain">{domain}</span>
                    <span className="source-rating" style={{color:"#94a3b8"}}>Not rated</span>
                    <span className="source-count">{count}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}

      {totalDomains > 0 && (
        <button onClick={() => setShowAll(!showAll)} style={{
          marginTop:"10px",background:"none",border:"1px solid #ccc1b7",borderRadius:"0",
          padding:"8px 14px",fontSize:"13px",color:"#33302e",cursor:"pointer",width:"100%",fontFamily:"'Source Sans 3', sans-serif"
        }}>
          {showAll ? "\u25B2 Show top 10" : `\u25BC View all ${totalDomains} sources`}
        </button>
      )}
    </Section>
  );
}

// ═══════════════════════════════════════════════════════════════════
// MULTI-FRAMEWORK SCORING TABLE
// ═══════════════════════════════════════════════════════════════════

function ScoreIndicator({ score, min = -1, max = 1 }) {
  const range = max - min;
  const pct = Math.max(0, Math.min(100, ((score - min) / range) * 100));
  const centerPct = ((0 - min) / range) * 100;
  const isPositive = score > 0;
  const barLeft = isPositive ? centerPct : pct;
  const barWidth = Math.abs(pct - centerPct);
  const color = score > 0.3 ? "#082a75" : score > 0.1 ? "#2e6c9e" : score < -0.3 ? "#990f3d" : score < -0.1 ? "#c0392b" : "#66605c";
  return (
    <div style={{position:"relative",height:"20px",background:"#f0e6db",width:"100%",minWidth:"120px"}}>
      <div style={{position:"absolute",left:`${centerPct}%`,top:0,bottom:0,width:"1px",background:"#66605c",zIndex:2}} />
      <div style={{position:"absolute",left:`${barLeft}%`,top:"2px",bottom:"2px",width:`${barWidth}%`,background:color,transition:"all 0.3s"}} />
    </div>
  );
}

function FrameworkScoreTable({ results: r }) {
  const [expanded, setExpanded] = useState(false);
  const frameworks = [
    { name: "VADER Sentiment", ref: "Hutto & Gilbert, 2014", score: r.sentiment.mean, label: r.sentiment.mean > 0.1 ? "Positive" : r.sentiment.mean < -0.1 ? "Negative" : "Neutral", desc: "Lexicon-based sentiment scoring using ~1,200 rated words. Measures emotional tone, not political leaning." },
    { name: "Entman Framing", ref: "Entman, 1993", score: r.entman.score, label: r.entman.label, desc: "Detects problem/causal/moral/solution frames associated with left vs right political discourse." },
    { name: "Van Dijk Ideological Square", ref: "Van Dijk, 1998", score: r.vanDijk.score, label: r.vanDijk.label, desc: "Measures Us/Them polarization: positive self-representation and negative other-representation." },
    { name: "Gentzkow-Shapiro Slant", ref: "Gentzkow & Shapiro, 2010", score: r.gentzkowShapiro.score, label: r.gentzkowShapiro.label, desc: "Counts partisan phrases characteristic of Democratic (+) vs Republican (-) congressional speech." },
    { name: "Fairclough CDA", ref: "Fairclough, 1995", score: r.fairclough.score, label: r.fairclough.label, desc: "Critical discourse analysis: passive voice, nominalization, modality, presupposition, evaluative language." },
  ];
  const avg = +(frameworks.reduce((s, f) => s + f.score, 0) / frameworks.length).toFixed(3);

  return (
    <div className="card">
      <button className="section-header" onClick={() => setExpanded(!expanded)}>
        <span className="section-icon">{"\uD83D\uDCCA"}</span>
        <span className="section-title">Multi-Framework Bias Scorecard</span>
        <span className="section-toggle">{expanded ? "\u25B2" : "\u25BC"}</span>
      </button>
      <div className="section-body">
        <p className="desc">Five peer-reviewed frameworks applied independently. All scores are deterministic and rule-based. Scale: -1.0 (Right) to +1.0 (Left/Loaded). Average: <strong>{avg > 0 ? "+" : ""}{avg}</strong></p>
        <div style={{overflowX:"auto"}}>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:"14px",fontFamily:"'Source Sans 3', sans-serif"}}>
            <thead>
              <tr style={{borderBottom:"2px solid #33302e",textAlign:"left"}}>
                <th style={{padding:"8px 12px",fontWeight:700,color:"#33302e",width:"200px"}}>Framework</th>
                <th style={{padding:"8px 12px",fontWeight:700,color:"#33302e",width:"70px",textAlign:"right"}}>Score</th>
                <th style={{padding:"8px 12px",fontWeight:700,color:"#33302e"}}>Direction</th>
                <th style={{padding:"8px 12px",fontWeight:700,color:"#33302e",minWidth:"120px"}}>Spectrum</th>
              </tr>
            </thead>
            <tbody>
              {frameworks.map((f, i) => (
                <tr key={i} style={{borderBottom:"1px solid #e8d5c4"}}>
                  <td style={{padding:"10px 12px"}}>
                    <div style={{fontWeight:600,color:"#33302e"}}>{f.name}</div>
                    <div style={{fontSize:"11px",color:"#a39d97",fontStyle:"italic"}}>{f.ref}</div>
                  </td>
                  <td style={{padding:"10px 12px",textAlign:"right",fontWeight:700,fontFamily:"'Source Sans 3', monospace",fontSize:"15px",color: f.score > 0.1 ? "#082a75" : f.score < -0.1 ? "#990f3d" : "#66605c"}}>
                    {f.score > 0 ? "+" : ""}{f.score.toFixed(3)}
                  </td>
                  <td style={{padding:"10px 12px",color:"#66605c"}}>{f.label}</td>
                  <td style={{padding:"10px 12px"}}><ScoreIndicator score={f.score} /></td>
                </tr>
              ))}
              <tr style={{borderTop:"2px solid #33302e",background:"#f6e9d8"}}>
                <td style={{padding:"10px 12px",fontWeight:700}}>Composite Average</td>
                <td style={{padding:"10px 12px",textAlign:"right",fontWeight:700,fontFamily:"monospace",fontSize:"15px",color: avg > 0.1 ? "#082a75" : avg < -0.1 ? "#990f3d" : "#66605c"}}>{avg > 0 ? "+" : ""}{avg}</td>
                <td style={{padding:"10px 12px",fontWeight:600,color:"#66605c"}}>{avg > 0.3 ? "Left" : avg > 0.1 ? "Moderate Left" : avg < -0.3 ? "Right" : avg < -0.1 ? "Moderate Right" : "Near Neutral"}</td>
                <td style={{padding:"10px 12px"}}><ScoreIndicator score={avg} /></td>
              </tr>
            </tbody>
          </table>
        </div>
        {expanded && (
          <div style={{marginTop:"16px",display:"flex",flexDirection:"column",gap:"12px"}}>
            {frameworks.map((f, i) => (
              <div key={i} style={{padding:"12px",background:"#fff",border:"1px solid #e8d5c4",fontSize:"13px"}}>
                <div style={{fontWeight:700,marginBottom:"4px",color:"#33302e"}}>{f.name}</div>
                <div style={{color:"#66605c",lineHeight:1.6}}>{f.desc}</div>
              </div>
            ))}
          </div>
        )}
        <button onClick={() => setExpanded(!expanded)} style={{
          marginTop:"10px",background:"none",border:"1px solid #ccc1b7",
          padding:"8px 14px",fontSize:"13px",color:"#33302e",cursor:"pointer",width:"100%",fontFamily:"'Source Sans 3', sans-serif"
        }}>
          {expanded ? "\u25B2 Hide framework details" : "\u25BC Show framework details"}
        </button>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════
// MAIN APP
// ═══════════════════════════════════════════════════════════════════

function WikiBiasAnalyzer() {
  const [query, setQuery] = useState("");
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [loading, setLoading] = useState(false);
  const [progress, setProgress] = useState("");
  const [results, setResults] = useState(null);
  const [articleTitle, setArticleTitle] = useState("");
  const inputRef = useRef(null);
  const timerRef = useRef(null);

  const fetchSuggestions = useCallback(async (q) => {
    if (q.length < 2) { setSuggestions([]); return; }
    try {
      const url = `https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(q)}&limit=8&namespace=0&format=json&origin=*`;
      const res = await fetch(url);
      const data = await res.json();
      setSuggestions(data[1] || []);
      setShowSuggestions(true);
    } catch(e) { setSuggestions([]); }
  }, []);

  useEffect(() => {
    clearTimeout(timerRef.current);
    timerRef.current = setTimeout(() => fetchSuggestions(query), 250);
    return () => clearTimeout(timerRef.current);
  }, [query, fetchSuggestions]);

  const analyze = async (title) => {
    setLoading(true);
    setResults(null);
    setArticleTitle(title);
    setShowSuggestions(false);
    setQuery(title);
    try {
      setProgress("Fetching article from Wikipedia...");
      const url = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=revisions&rvprop=content&rvslots=main&format=json&origin=*`;
      const res = await fetch(url);
      const data = await res.json();
      const pages = data?.query?.pages;
      if (!pages) throw new Error("Article not found");
      const page = Object.values(pages)[0];
      if (!page.revisions) throw new Error("Article not found");
      const wikitext = page.revisions[0].slots.main["*"];
      const actualTitle = page.title;
      setArticleTitle(actualTitle);

      setProgress("Parsing article structure...");
      await new Promise(r => setTimeout(r, 50));
      const sections = parseWikitext(wikitext);
      const plainText = Object.values(sections).join(" ");
      const wordCount = plainText.split(/\s+/).length;

      const safe = (label, fn) => { try { const r = fn(); console.log("[WBA] " + label + " OK"); return r; } catch(e) { console.error("[WBA] " + label + " FAILED:", e); return null; } };

      setProgress("[1/9] Analyzing source bias profile...");
      await new Promise(r => setTimeout(r, 50));
      const sourceBias = safe("sourceBias", () => analyzeSourceBias(wikitext)) || { mean: null, label: "Error", classified: {}, unclassified: {}, totalC: 0, totalU: 0, dist: {"-2":0,"-1":0,"0":0,"1":0,"2":0}, total: 0 };

      setProgress("[2/9] Checking Wikipedia policy compliance...");
      await new Promise(r => setTimeout(r, 50));
      const policy = safe("policy", () => analyzePolicyCompliance(plainText)) || { weasel: {count:0,density:0,examples:[]}, peacock: {count:0,density:0,examples:[]}, editorial: {count:0,density:0,examples:[]}, total: {count:0,density:0} };

      setProgress("[3/9] Running VADER sentiment analysis...");
      await new Promise(r => setTimeout(r, 50));
      const sentiment = safe("sentiment", () => analyzeSentiment(sections)) || { mean: 0, posPct: 0, negPct: 0, neuPct: 0, leadBodyGap: 0, sections: {}, bestPos: {text:"",score:0}, bestNeg: {text:"",score:0} };

      setProgress("[4/9] Analyzing structural balance...");
      await new Promise(r => setTimeout(r, 50));
      const structure = safe("structure", () => analyzeStructure(sections, wikitext)) || { sections: 0, totalWords: 0, gini: 0, largest: {name:"",pct:0}, sectionSizes: {}, hasCriticism: false, hasReception: false, refTotal: 0, refDensity: 0 };

      setProgress("[5/9] Running lexical analysis...");
      await new Promise(r => setTimeout(r, 50));
      const lexical = safe("lexical", () => analyzeLexical(plainText)) || { wordCount: 0, ttr: 0, hapaxRatio: 0, hedging: {count:0,density:0}, intensifiers: {count:0,density:0}, superlatives: {count:0,density:0}, passive: {count:0,density:0} };

      setProgress("[6/9] Entman framing analysis...");
      await new Promise(r => setTimeout(r, 50));
      const entman = safe("entman", () => analyzeEntmanFraming(plainText)) || { score: 0, leftScore: 0, rightScore: 0, details: {left:{problem:0,causal:0,moral:0,solution:0},right:{problem:0,causal:0,moral:0,solution:0}}, label: "N/A" };

      setProgress("[7/9] Gentzkow-Shapiro slant index...");
      await new Promise(r => setTimeout(r, 50));
      const gentzkowShapiro = safe("gentzkowShapiro", () => analyzeGentzkowShapiro(plainText)) || { score: 0, leftCount: 0, rightCount: 0, total: 0, leftFound: [], rightFound: [], label: "N/A" };

      setProgress("[8/9] Van Dijk ideological analysis...");
      await new Promise(r => setTimeout(r, 50));
      const vanDijk = safe("vanDijk", () => analyzeVanDijk(plainText)) || { score: 0, polarization: 0, usPositive: 0, usNegative: 0, themPositive: 0, themNegative: 0, totalMarkers: 0, label: "N/A" };

      setProgress("[9/9] Fairclough discourse analysis...");
      await new Promise(r => setTimeout(r, 50));
      const fairclough = safe("fairclough", () => analyzeFairlough(plainText)) || { score: 0, passiveRatio: 0, nomRatio: 0, modalityBalance: 0, presupCount: 0, evalDensity: 0, highCertaintyCount: 0, lowCertaintyCount: 0, passiveCount: 0, nomCount: 0, evalCount: 0, label: "N/A" };

      console.log("[WBA] All analyses complete, rendering results...");
      setResults({ sourceBias, policy, sentiment, structure, lexical, entman, gentzkowShapiro, vanDijk, fairclough, wordCount, sectionCount: Object.keys(sections).length, title: actualTitle, sections, plainText });
    } catch (e) {
      setResults({ error: e.message });
    }
    setLoading(false);
    setProgress("");
  };

  const r = results;

  // ─── SEARCH PAGE ───
  if (!r && !loading) {
    return (
      <div className="center-page">
        <div className="search-box" style={{display:"flex",flexDirection:"column",gap:"32px"}}>
          <div style={{textAlign:"center",display:"flex",flexDirection:"column",gap:"12px"}}>
            <div style={{fontSize:"48px",fontWeight:900,color:"#33302e",fontFamily:"'Playfair Display', Georgia, serif"}}>W</div>
            <h1 style={{fontSize:"28px",fontWeight:700,color:"#33302e",fontFamily:"'Playfair Display', Georgia, serif",letterSpacing:"-0.02em"}}>Wikipedia Bias Analyzer</h1>
            <p style={{fontSize:"14px",color:"#66605c",maxWidth:"420px",margin:"0 auto",lineHeight:1.6}}>Deterministic, transparent, and replicable bias detection for any English Wikipedia article. Powered by AllSides ratings, Wikipedia policy word lists, and VADER sentiment analysis.</p>
          </div>
          <div style={{position:"relative"}}>
            <input
              ref={inputRef}
              type="text"
              value={query}
              onChange={e => setQuery(e.target.value)}
              onFocus={() => suggestions.length > 0 && setShowSuggestions(true)}
              onKeyDown={e => { if (e.key === "Enter" && query.trim()) analyze(query.trim()); }}
              placeholder="Type a Wikipedia article title..."
              className="search-input"
            />
            {showSuggestions && suggestions.length > 0 && (
              <div className="suggestions">
                {suggestions.map((s, i) => (
                  <button key={i} className="suggestion-btn" onClick={() => { setQuery(s); setShowSuggestions(false); analyze(s); }}>
                    {s}
                  </button>
                ))}
              </div>
            )}
          </div>
          <div style={{textAlign:"center"}}>
            <button className="btn-primary" onClick={() => query.trim() && analyze(query.trim())} disabled={!query.trim()}>
              Analyze Article
            </button>
          </div>
          <div className="five-col">
            <div>Source Bias</div><div>WP:NPOV</div><div>Sentiment</div><div>Structure</div><div>Lexical</div>
          </div>
        </div>
      </div>
    );
  }

  // ─── LOADING STATE ───
  if (loading) {
    return (
      <div className="center-page">
        <div style={{textAlign:"center",display:"flex",flexDirection:"column",gap:"24px",alignItems:"center"}}>
          <div className="spinner" />
          <div>
            <h2 style={{fontSize:"20px",fontWeight:600,color:"#334155"}}>Analyzing: {articleTitle}</h2>
            <p style={{color:"#64748b",marginTop:"8px"}}>{progress}</p>
          </div>
        </div>
      </div>
    );
  }

  // ─── ERROR ───
  if (r.error) {
    return (
      <div className="center-page">
        <div style={{textAlign:"center",display:"flex",flexDirection:"column",gap:"16px",alignItems:"center"}}>
          <div style={{fontSize:"40px"}}>:(</div>
          <h2 style={{fontSize:"20px",fontWeight:600,color:"#dc2626"}}>Error: {r.error}</h2>
          <button className="btn-primary" onClick={() => { setResults(null); setQuery(""); }}>Try Again</button>
        </div>
      </div>
    );
  }

  // ─── RESULTS PAGE ───
  const sb = r.sourceBias;
  const topSources = Object.entries(sb.classified).sort((a,b) => b[1].count - a[1].count).slice(0,10);
  const allClassified = Object.entries(sb.classified).sort((a,b) => b[1].count - a[1].count);
  const allUnclassified = Object.entries(sb.unclassified).sort((a,b) => b[1] - a[1]);

  return (
    <div className="container">
      {/* Header */}
      <div className="header-bar">
        <div>
          <div className="header-title">{r.title}</div>
          <div className="header-sub">{r.wordCount.toLocaleString()} words &middot; {r.sectionCount} sections</div>
        </div>
        <button className="btn-secondary" onClick={() => { setResults(null); setQuery(""); }}>New Analysis</button>
      </div>

      {/* Multi-Framework Scoring Table */}
      <FrameworkScoreTable results={r} />

      {/* Module 1: Source Bias */}
      <SourceBiasSection sb={sb} topSources={topSources} allClassified={allClassified} allUnclassified={allUnclassified} />

      {/* Module 2: Policy Compliance */}
      <PolicySection policy={r.policy} sections={r.sections} />

      {/* Module 3: Sentiment */}
      <Section title="Sentiment Asymmetry (VADER)" icon={"\uD83D\uDE10"} sources={[
        {name:"VADER Sentiment Lexicon",url:"https://github.com/cjhutto/vaderSentiment",detail:"~1,200 human-rated words with valence scores from -4.0 to +4.0, validated on social media text"},
        {name:"Hutto & Gilbert (2014)",url:"https://ojs.aaai.org/index.php/ICWSM/article/view/14550",detail:"'VADER: A Parsimonious Rule-Based Model for Sentiment Analysis of Social Media Text' — ICWSM 2014"},
        {name:"Compact lexicon (embedded)",detail:"Subset of ~1,200 highest-impact words from the full VADER lexicon, embedded directly in the analyzer"},
      ]}>
        <p className="desc">VADER rule-based sentiment (<a href="https://github.com/cjhutto/vaderSentiment" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Hutto &amp; Gilbert 2014</a>). Deterministic lexicon of ~1,200 scored words. Scale: -1.0 to +1.0. <a href="https://ojs.aaai.org/index.php/ICWSM/article/view/14550" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Paper</a></p>
        <div className="stats-grid stats-5">
          <Stat label="Mean" value={(r.sentiment.mean > 0 ? "+" : "") + r.sentiment.mean.toFixed(3)} />
          <Stat label="Positive" value={`${r.sentiment.posPct}%`} />
          <Stat label="Negative" value={`${r.sentiment.negPct}%`} />
          <Stat label="Neutral" value={`${r.sentiment.neuPct}%`} />
          <Stat label="Lead-Body Gap" value={(r.sentiment.leadBodyGap > 0 ? "+" : "") + r.sentiment.leadBodyGap.toFixed(3)} />
        </div>
        <div>
          <div className="small-title">Per-Section Sentiment</div>
          {Object.entries(r.sentiment.sections).map(([name, data]) => (
            <SentimentBar key={name} name={name} data={data} />
          ))}
        </div>
        {r.sentiment.bestPos.text && (
          <div className="quote-box quote-green">
            <span className="quote-label-green">Most positive ({r.sentiment.bestPos.score.toFixed(3)}):</span> "{r.sentiment.bestPos.text}..."
          </div>
        )}
        {r.sentiment.bestNeg.text && (
          <div className="quote-box quote-red">
            <span className="quote-label-red">Most negative ({r.sentiment.bestNeg.score.toFixed(3)}):</span> "{r.sentiment.bestNeg.text}..."
          </div>
        )}
      </Section>

      {/* Module 4: Structure */}
      <Section title="Structural Balance" icon={"\uD83C\uDFD7\uFE0F"} sources={[
        {name:"Gini coefficient",url:"https://en.wikipedia.org/wiki/Gini_coefficient",detail:"Statistical measure of inequality (0=perfectly even, 1=maximally skewed) applied to section word counts"},
        {name:"Wikipedia:Verifiability (WP:V)",url:"https://en.wikipedia.org/wiki/Wikipedia:Verifiability",detail:"Core content policy requiring inline citations; reference density measured as refs per 1,000 words"},
        {name:"Wikipedia:Neutral point of view",url:"https://en.wikipedia.org/wiki/Wikipedia:Neutral_point_of_view",detail:"Checks for Criticism/Controversy and Reception/Response sections as structural balance indicators"},
      ]}>
        <p className="desc">Section sizes, citation distribution, and <a href="https://en.wikipedia.org/wiki/Gini_coefficient" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Gini coefficient</a> for structural evenness. Reference density per <a href="https://en.wikipedia.org/wiki/Wikipedia:Verifiability" target="_blank" rel="noopener" style={{color:"#0d7680"}}>WP:V</a>.</p>
        <div className="stats-grid stats-4">
          <Stat label="Sections" value={r.structure.sections} />
          <Stat label="Gini Coeff." value={r.structure.gini.toFixed(3)} sub="0=even, 1=skewed" />
          <Stat label="Ref Density" value={`${r.structure.refDensity}/1k`} />
          <Stat label="Total Refs" value={r.structure.refTotal} />
        </div>
        <div>
          <div className="small-title">Section Proportions</div>
          {Object.entries(r.structure.sectionSizes).sort((a,b) => b[1] - a[1]).slice(0, 15).map(([name, wc]) => {
            const pct = r.structure.totalWords > 0 ? (wc / r.structure.totalWords * 100) : 0;
            return (
              <div key={name} className="section-prop-row">
                <span className="section-prop-name" title={name}>{name}</span>
                <div className="section-prop-track">
                  <div className="section-prop-fill" style={{ width: `${pct}%` }} />
                </div>
                <span className="section-prop-val">{pct.toFixed(1)}%</span>
              </div>
            );
          })}
        </div>
        <div className="tags-row">
          <span className={`tag ${r.structure.hasCriticism ? "tag-green" : "tag-gray"}`}>
            {r.structure.hasCriticism ? "\u2713" : "\u2717"} Criticism/Controversy
          </span>
          <span className={`tag ${r.structure.hasReception ? "tag-green" : "tag-gray"}`}>
            {r.structure.hasReception ? "\u2713" : "\u2717"} Reception/Response
          </span>
        </div>
      </Section>

      {/* Module 5: Lexical */}
      <Section title="Lexical Analysis" icon={"\uD83D\uDD24"} sources={[
        {name:"Type-Token Ratio (TTR)",url:"https://en.wikipedia.org/wiki/Lexical_density",detail:"Vocabulary diversity metric: unique words / total words. Higher = more diverse vocabulary"},
        {name:"Hapax legomenon ratio",url:"https://en.wikipedia.org/wiki/Hapax_legomenon",detail:"Words appearing exactly once / total words. Higher = richer, less repetitive language"},
        {name:"Wikipedia:Manual of Style",url:"https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style",detail:"Source for hedging, intensifier, and superlative word lists (HEDGING: 28 phrases, INTENSIFIERS: 16, SUPERLATIVES: 15)"},
        {name:"Passive voice regex",detail:"Pattern-matching ~30 passive constructions (e.g., 'was found', 'were built', 'has been shown')"},
      ]}>
        <p className="desc">Vocabulary diversity (<a href="https://en.wikipedia.org/wiki/Lexical_density" target="_blank" rel="noopener" style={{color:"#0d7680"}}>TTR</a>, <a href="https://en.wikipedia.org/wiki/Hapax_legomenon" target="_blank" rel="noopener" style={{color:"#0d7680"}}>hapax ratio</a>), passive voice, hedging, intensifiers, and superlatives. Word lists from <a href="https://en.wikipedia.org/wiki/Wikipedia:Manual_of_Style" target="_blank" rel="noopener" style={{color:"#0d7680"}}>WP:MOS</a>.</p>
        <div className="stats-grid stats-4">
          <Stat label="Words" value={r.lexical.wordCount?.toLocaleString()} />
          <Stat label="Type-Token Ratio" value={r.lexical.ttr?.toFixed(3)} sub="vocab diversity" />
          <Stat label="Hapax Ratio" value={r.lexical.hapaxRatio?.toFixed(3)} />
          <Stat label="Passive Voice" value={r.lexical.passive?.count} sub={`${r.lexical.passive?.density}/1k`} />
        </div>
        <MetricBar label="Hedging" value={r.lexical.hedging?.density || 0} max={30} color="#6366f1" suffix="/1k" />
        <MetricBar label="Intensifiers" value={r.lexical.intensifiers?.density || 0} max={15} color="#f43f5e" suffix="/1k" />
        <MetricBar label="Superlatives" value={r.lexical.superlatives?.density || 0} max={10} color="#f59e0b" suffix="/1k" />
        <MetricBar label="Passive Voice" value={r.lexical.passive?.density || 0} max={30} color="#64748b" suffix="/1k" />
      </Section>

      {/* Module 6: Entman Framing */}
      <Section title="Entman Framing Analysis" icon={"\uD83D\uDDBC\uFE0F"} defaultOpen={false} sources={[
        {name:"Entman, R.M. (1993)",url:"https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1460-2466.1993.tb01304.x",detail:"'Framing: Toward Clarification of a Fractured Paradigm' — Journal of Communication, 43(4), 51-58"},
        {name:"Custom frame lexicon (embedded)",detail:"4 frame types (problem/causal/moral/solution) × 2 directions (left/right) = 8 phrase lists, ~100 phrases total"},
        {name:"Frame weighting schema",detail:"Weighted scoring: problem=1.0×, causal=1.2×, moral=1.5×, solution=1.0× — moral frames weighted higher per Entman's salience theory"},
      ]}>
        <p className="desc"><a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1460-2466.1993.tb01304.x" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Entman (1993)</a>: Identifies problem/causal/moral/solution frames associated with left vs right political discourse. Score: {r.entman.score > 0 ? "+" : ""}{r.entman.score} ({r.entman.label})</p>
        <div className="stats-grid stats-4">
          <Stat label="Score" value={(r.entman.score > 0 ? "+" : "") + r.entman.score.toFixed(3)} sub={r.entman.label} />
          <Stat label="Left Frames" value={r.entman.leftScore} />
          <Stat label="Right Frames" value={r.entman.rightScore} />
          <Stat label="Total" value={+(r.entman.leftScore + r.entman.rightScore).toFixed(1)} />
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px",marginTop:"8px"}}>
          <div style={{background:"#eef0f8",padding:"10px",fontSize:"13px"}}>
            <div style={{fontWeight:700,color:"#082a75",marginBottom:"4px"}}>Left Frames</div>
            {Object.entries(r.entman.details.left).filter(([,v])=>v>0).map(([cat,count])=>(
              <div key={cat} style={{display:"flex",justifyContent:"space-between"}}><span style={{textTransform:"capitalize"}}>{cat}</span><span style={{fontWeight:600}}>{count}</span></div>
            ))}
            {Object.values(r.entman.details.left).every(v=>v===0) && <div style={{color:"#a39d97",fontStyle:"italic"}}>None detected</div>}
          </div>
          <div style={{background:"#fdf0ee",padding:"10px",fontSize:"13px"}}>
            <div style={{fontWeight:700,color:"#990f3d",marginBottom:"4px"}}>Right Frames</div>
            {Object.entries(r.entman.details.right).filter(([,v])=>v>0).map(([cat,count])=>(
              <div key={cat} style={{display:"flex",justifyContent:"space-between"}}><span style={{textTransform:"capitalize"}}>{cat}</span><span style={{fontWeight:600}}>{count}</span></div>
            ))}
            {Object.values(r.entman.details.right).every(v=>v===0) && <div style={{color:"#a39d97",fontStyle:"italic"}}>None detected</div>}
          </div>
        </div>
      </Section>

      {/* Module 7: Gentzkow-Shapiro */}
      <Section title="Gentzkow-Shapiro Slant Index" icon={"\uD83C\uDFDB\uFE0F"} defaultOpen={false} sources={[
        {name:"Gentzkow, M. & Shapiro, J.M. (2010)",url:"https://web.stanford.edu/~gentzkow/research/biasmeas.pdf",detail:"'What Drives Media Slant? Evidence from U.S. Daily Newspapers' — Econometrica, 78(1), 35-71"},
        {name:"Congressional Record phrase database",detail:"Adapted from Gentzkow-Shapiro methodology: 48 Democratic-leaning and 49 Republican-leaning phrases identified from congressional speech frequency differentials"},
        {name:"Partisan phrase lists (embedded)",detail:"Examples: 'estate tax' vs 'death tax', 'climate change' vs 'energy independence', 'gun safety' vs 'second amendment rights'"},
      ]}>
        <p className="desc"><a href="https://web.stanford.edu/~gentzkow/research/biasmeas.pdf" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Gentzkow &amp; Shapiro (2010)</a>: Measures political slant via phrase frequency similarity to Democratic (+) vs Republican (-) congressional speech patterns.</p>
        <div className="stats-grid stats-4">
          <Stat label="Slant Score" value={(r.gentzkowShapiro.score > 0 ? "+" : "") + r.gentzkowShapiro.score.toFixed(3)} sub={r.gentzkowShapiro.label} />
          <Stat label="Dem Phrases" value={r.gentzkowShapiro.leftCount} />
          <Stat label="GOP Phrases" value={r.gentzkowShapiro.rightCount} />
          <Stat label="Total" value={r.gentzkowShapiro.total} />
        </div>
        {(r.gentzkowShapiro.leftFound.length > 0 || r.gentzkowShapiro.rightFound.length > 0) && (
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px",marginTop:"8px"}}>
            <div style={{background:"#eef0f8",padding:"10px",fontSize:"13px"}}>
              <div style={{fontWeight:700,color:"#082a75",marginBottom:"4px"}}>Democratic-Leaning Phrases</div>
              {r.gentzkowShapiro.leftFound.map(({phrase,count})=>(
                <div key={phrase} style={{display:"flex",justifyContent:"space-between"}}><span>"{phrase}"</span><span style={{fontWeight:600}}>{count}</span></div>
              ))}
              {r.gentzkowShapiro.leftFound.length === 0 && <div style={{color:"#a39d97",fontStyle:"italic"}}>None detected</div>}
            </div>
            <div style={{background:"#fdf0ee",padding:"10px",fontSize:"13px"}}>
              <div style={{fontWeight:700,color:"#990f3d",marginBottom:"4px"}}>Republican-Leaning Phrases</div>
              {r.gentzkowShapiro.rightFound.map(({phrase,count})=>(
                <div key={phrase} style={{display:"flex",justifyContent:"space-between"}}><span>"{phrase}"</span><span style={{fontWeight:600}}>{count}</span></div>
              ))}
              {r.gentzkowShapiro.rightFound.length === 0 && <div style={{color:"#a39d97",fontStyle:"italic"}}>None detected</div>}
            </div>
          </div>
        )}
        {r.gentzkowShapiro.total === 0 && <div style={{padding:"12px",background:"#f6e9d8",color:"#66605c",fontSize:"13px",fontStyle:"italic"}}>No partisan phrases detected. Wikipedia articles often use neutral language that avoids partisan framing.</div>}
      </Section>

      {/* Module 8: Van Dijk */}
      <Section title="Van Dijk Ideological Square" icon={"\u2B1C"} defaultOpen={false} sources={[
        {name:"Van Dijk, T.A. (1998)",url:"https://discourses.org/wp-content/uploads/2022/07/Teun-A.-van-Dijk-1998-Ideology-A-Multidisciplinary-Approach.pdf",detail:"'Ideology: A Multidisciplinary Approach' — Sage Publications. Chapter on ideological square discourse structures"},
        {name:"Us/Them marker lists (embedded)",detail:"16 in-group markers ('we', 'our', 'citizens', 'allies') and 17 out-group markers ('they', 'enemies', 'regime', 'extremist')"},
        {name:"Descriptor lexicons (embedded)",detail:"25 positive descriptors ('democratic', 'freedom', 'innovative') and 24 negative descriptors ('corrupt', 'reckless', 'authoritarian')"},
        {name:"Sentence-level co-occurrence analysis",detail:"Scores assigned per-sentence based on co-occurrence of Us/Them markers with positive/negative descriptors"},
      ]}>
        <p className="desc"><a href="https://en.wikipedia.org/wiki/Teun_A._van_Dijk" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Van Dijk (1998)</a>: Measures Us/Them polarization by tracking positive/negative descriptors applied to in-group vs out-group references.</p>
        <div className="stats-grid stats-4">
          <Stat label="Polarization" value={(r.vanDijk.score > 0 ? "+" : "") + r.vanDijk.score.toFixed(3)} sub={r.vanDijk.label} />
          <Stat label="Us+ / Us-" value={`${r.vanDijk.usPositive} / ${r.vanDijk.usNegative}`} />
          <Stat label="Them+ / Them-" value={`${r.vanDijk.themPositive} / ${r.vanDijk.themNegative}`} />
          <Stat label="Total Markers" value={r.vanDijk.totalMarkers} />
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1px",background:"#e8d5c4",marginTop:"12px"}}>
          <div style={{background:"#e8f5e9",padding:"12px",textAlign:"center"}}>
            <div style={{fontSize:"11px",color:"#66605c",textTransform:"uppercase",letterSpacing:"0.05em"}}>Emphasize Us+</div>
            <div style={{fontSize:"24px",fontWeight:700,color:"#2e7d32"}}>{r.vanDijk.usPositive}</div>
          </div>
          <div style={{background:"#fce4ec",padding:"12px",textAlign:"center"}}>
            <div style={{fontSize:"11px",color:"#66605c",textTransform:"uppercase",letterSpacing:"0.05em"}}>Emphasize Them-</div>
            <div style={{fontSize:"24px",fontWeight:700,color:"#c62828"}}>{r.vanDijk.themNegative}</div>
          </div>
          <div style={{background:"#fff3e0",padding:"12px",textAlign:"center"}}>
            <div style={{fontSize:"11px",color:"#66605c",textTransform:"uppercase",letterSpacing:"0.05em"}}>Mitigate Us-</div>
            <div style={{fontSize:"24px",fontWeight:700,color:"#e65100"}}>{r.vanDijk.usNegative}</div>
          </div>
          <div style={{background:"#e3f2fd",padding:"12px",textAlign:"center"}}>
            <div style={{fontSize:"11px",color:"#66605c",textTransform:"uppercase",letterSpacing:"0.05em"}}>Mitigate Them+</div>
            <div style={{fontSize:"24px",fontWeight:700,color:"#1565c0"}}>{r.vanDijk.themPositive}</div>
          </div>
        </div>
      </Section>

      {/* Module 9: Fairclough CDA */}
      <Section title="Fairclough Critical Discourse Analysis" icon={"\uD83D\uDD0D"} defaultOpen={false} sources={[
        {name:"Fairclough, N. (1995)",url:"https://www.routledge.com/Critical-Discourse-Analysis-The-Critical-Study-of-Language/Fairclough/p/book/9781138226852",detail:"'Critical Discourse Analysis: The Critical Study of Language' — Longman. Three-dimensional CDA framework"},
        {name:"Passive voice patterns",detail:"Regex matching ~30 passive constructions — measures agency obscuring (e.g., 'was decided' hides who decided)"},
        {name:"Nominalization suffixes",detail:"10 suffix patterns (-tion, -sion, -ment, -ness, -ance, -ence, -ity, -ism, -ist, -age) — converts processes to things"},
        {name:"Modality markers",detail:"11 high-certainty words ('must', 'certainly') vs 12 low-certainty words ('may', 'arguably') — epistemic stance analysis"},
        {name:"Presupposition triggers",detail:"12 phrases that present assumptions as fact ('the fact that', 'it is well known', 'of course')"},
        {name:"Evaluative adjective list",detail:"25 value-laden adjectives ('significant', 'controversial', 'unprecedented') — measures ideological loading"},
      ]}>
        <p className="desc"><a href="https://en.wikipedia.org/wiki/Critical_discourse_analysis" target="_blank" rel="noopener" style={{color:"#0d7680"}}>Fairclough (1995)</a>: Analyzes how linguistic choices construct power and ideology. Higher scores = more ideologically loaded language.</p>
        <div className="stats-grid stats-4">
          <Stat label="CDA Score" value={(r.fairclough.score > 0 ? "+" : "") + r.fairclough.score.toFixed(3)} sub={r.fairclough.label} />
          <Stat label="Passive Voice" value={r.fairclough.passiveCount} sub={`${r.fairclough.passiveRatio}/100w`} />
          <Stat label="Nominalizations" value={r.fairclough.nomCount} sub={`${r.fairclough.nomRatio}/100w`} />
          <Stat label="Evaluative" value={r.fairclough.evalCount} sub={`${r.fairclough.evalDensity}/1k`} />
        </div>
        <MetricBar label="Passive Voice" value={r.fairclough.passiveRatio} max={8} color="#6366f1" suffix="/100w" />
        <MetricBar label="Nominalization" value={r.fairclough.nomRatio} max={20} color="#8b5cf6" suffix="/100w" />
        <MetricBar label="Evaluative Language" value={r.fairclough.evalDensity} max={25} color="#f59e0b" suffix="/1k" />
        <MetricBar label="Presuppositions" value={r.fairclough.presupCount} max={20} color="#ef4444" suffix=" total" />
        <div style={{marginTop:"8px",fontSize:"13px",color:"#66605c"}}>
          <strong>Modality Balance:</strong> {r.fairclough.highCertaintyCount} high-certainty vs {r.fairclough.lowCertaintyCount} low-certainty markers
          ({r.fairclough.modalityBalance > 0 ? "assertive" : r.fairclough.modalityBalance < 0 ? "hedged" : "balanced"} discourse)
        </div>
      </Section>

      {/* Module 10: LLM Analysis */}
      <LLMAnalysisSection plainText={r.plainText} title={r.title} />

      {/* Footer */}
      <div className="footer">
        <p>Modules 1-9 are deterministic and rule-based. Same article always produces identical results. Click <strong>"sources"</strong> on any module header to see the databases and papers consulted.</p>
      </div>
    </div>
  );
}

ReactDOM.render(<ErrorBoundary><WikiBiasAnalyzer /></ErrorBoundary>, document.getElementById("root"));
</script>
</body>
</html>
